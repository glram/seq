

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Program Listing for File format.h &mdash; Seq 0.9.6 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script src="../_static/collapsible-lists/js/CollapsibleLists.compressed.js"></script>
        <script src="../_static/collapsible-lists/js/apply-collapsible-lists.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/collapsible-lists/css/tree_view.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #333131" >
          

          
            <a href="../index.html" class="icon icon-home"> Seq
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.9
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cookbook.html">Cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../python.html">Calling Python from Seq</a></li>
<li class="toctree-l1"><a class="reference internal" href="../embed.html">Calling Seq from C/C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="../build.html">Building from Source</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internals.html">Compiler Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="doxygen.html">Compiler API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Seq</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Program Listing for File format.h</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/api/program_listing_file_compiler_util_fmt_format.h.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="program-listing-for-file-format-h">
<span id="program-listing-file-compiler-util-fmt-format-h"></span><h1>Program Listing for File format.h<a class="headerlink" href="#program-listing-for-file-format-h" title="Permalink to this headline">¶</a></h1>
<p>↰ <a class="reference internal" href="file_compiler_util_fmt_format.h.html#file-compiler-util-fmt-format-h"><span class="std std-ref">Return to documentation for file</span></a> (<code class="docutils literal notranslate"><span class="pre">compiler/util/fmt/format.h</span></code>)</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="cm">/*</span>
<span class="cm"> Formatting library for C++</span>

<span class="cm"> Copyright (c) 2012 - present, Victor Zverovich</span>

<span class="cm"> Permission is hereby granted, free of charge, to any person obtaining</span>
<span class="cm"> a copy of this software and associated documentation files (the</span>
<span class="cm"> &quot;Software&quot;), to deal in the Software without restriction, including</span>
<span class="cm"> without limitation the rights to use, copy, modify, merge, publish,</span>
<span class="cm"> distribute, sublicense, and/or sell copies of the Software, and to</span>
<span class="cm"> permit persons to whom the Software is furnished to do so, subject to</span>
<span class="cm"> the following conditions:</span>

<span class="cm"> The above copyright notice and this permission notice shall be</span>
<span class="cm"> included in all copies or substantial portions of the Software.</span>

<span class="cm"> THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="cm"> EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF</span>
<span class="cm"> MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="cm"> NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE</span>
<span class="cm"> LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION</span>
<span class="cm"> OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION</span>
<span class="cm"> WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="cm"> --- Optional exception to the license ---</span>

<span class="cm"> As an exception, if, as a result of your compiling your source code, portions</span>
<span class="cm"> of this Software are embedded into a machine-executable object form of such</span>
<span class="cm"> source code, you may redistribute such embedded portions in such object form</span>
<span class="cm"> without including the above copyright and permission notices.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef FMT_FORMAT_H_</span>
<span class="cp">#define FMT_FORMAT_H_</span>

<span class="cp">#include</span> <span class="cpf">&quot;core.h&quot;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;algorithm&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cerrno&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cmath&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;cstdint&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;limits&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;memory&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdexcept&gt;</span><span class="cp"></span>

<span class="cp">#ifdef __clang__</span>
<span class="cp">#define FMT_CLANG_VERSION (__clang_major__ * 100 + __clang_minor__)</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_CLANG_VERSION 0</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __INTEL_COMPILER</span>
<span class="cp">#define FMT_ICC_VERSION __INTEL_COMPILER</span>
<span class="cp">#elif defined(__ICL)</span>
<span class="cp">#define FMT_ICC_VERSION __ICL</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_ICC_VERSION 0</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __NVCC__</span>
<span class="cp">#define FMT_CUDA_VERSION (__CUDACC_VER_MAJOR__ * 100 + __CUDACC_VER_MINOR__)</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_CUDA_VERSION 0</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __has_builtin</span>
<span class="cp">#define FMT_HAS_BUILTIN(x) __has_builtin(x)</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_HAS_BUILTIN(x) 0</span>
<span class="cp">#endif</span>

<span class="cp">#if FMT_HAS_CPP_ATTRIBUTE(fallthrough) &amp;&amp;                                      \</span>
<span class="cp">    (__cplusplus &gt;= 201703 || FMT_GCC_VERSION != 0)</span>
<span class="cp">#define FMT_FALLTHROUGH [[fallthrough]]</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_FALLTHROUGH</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef FMT_THROW</span>
<span class="cp">#if FMT_EXCEPTIONS</span>
<span class="cp">#if FMT_MSC_VER</span>
<span class="n">FMT_BEGIN_NAMESPACE</span>
<span class="k">namespace</span> <span class="n">internal</span> <span class="p">{</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Exception</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">do_throw</span><span class="p">(</span><span class="k">const</span> <span class="n">Exception</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Silence unreachable code warnings in MSVC because these are nearly</span>
  <span class="c1">// impossible to fix in a generic code.</span>
  <span class="k">volatile</span> <span class="kt">bool</span> <span class="n">b</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="k">throw</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace internal</span>
<span class="n">FMT_END_NAMESPACE</span>
<span class="cp">#define FMT_THROW(x) internal::do_throw(x)</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_THROW(x) throw x</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_THROW(x)                                                           \</span>
<span class="cp">  do {                                                                         \</span>
<span class="cp">    static_cast&lt;void&gt;(sizeof(x));                                              \</span>
<span class="cp">    FMT_ASSERT(false, &quot;&quot;);                                                     \</span>
<span class="cp">  } while (false)</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef FMT_USE_USER_DEFINED_LITERALS</span>
<span class="c1">// For Intel and NVIDIA compilers both they and the system gcc/msc support UDLs.</span>
<span class="cp">#if (FMT_HAS_FEATURE(cxx_user_literals) || FMT_GCC_VERSION &gt;= 407 ||           \</span>
<span class="cp">     FMT_MSC_VER &gt;= 1900) &amp;&amp;                                                   \</span>
<span class="cp">    (!(FMT_ICC_VERSION || FMT_CUDA_VERSION) || FMT_ICC_VERSION &gt;= 1500 ||      \</span>
<span class="cp">     FMT_CUDA_VERSION &gt;= 700)</span>
<span class="cp">#define FMT_USE_USER_DEFINED_LITERALS 1</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_USE_USER_DEFINED_LITERALS 0</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef FMT_USE_UDL_TEMPLATE</span>
<span class="c1">// EDG front end based compilers (icc, nvcc) do not support UDL templates yet</span>
<span class="c1">// and GCC 9 warns about them.</span>
<span class="cp">#if FMT_USE_USER_DEFINED_LITERALS &amp;&amp; FMT_ICC_VERSION == 0 &amp;&amp;                   \</span>
<span class="cp">    FMT_CUDA_VERSION == 0 &amp;&amp;                                                   \</span>
<span class="cp">    ((FMT_GCC_VERSION &gt;= 600 &amp;&amp; FMT_GCC_VERSION &lt;= 900 &amp;&amp;                      \</span>
<span class="cp">      __cplusplus &gt;= 201402L) ||                                               \</span>
<span class="cp">     FMT_CLANG_VERSION &gt;= 304)</span>
<span class="cp">#define FMT_USE_UDL_TEMPLATE 1</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_USE_UDL_TEMPLATE 0</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="c1">// __builtin_clz is broken in clang with Microsoft CodeGen:</span>
<span class="c1">// https://github.com/fmtlib/fmt/issues/519</span>
<span class="cp">#if (FMT_GCC_VERSION || FMT_HAS_BUILTIN(__builtin_clz)) &amp;&amp; !FMT_MSC_VER</span>
<span class="cp">#define FMT_BUILTIN_CLZ(n) __builtin_clz(n)</span>
<span class="cp">#endif</span>
<span class="cp">#if (FMT_GCC_VERSION || FMT_HAS_BUILTIN(__builtin_clzll)) &amp;&amp; !FMT_MSC_VER</span>
<span class="cp">#define FMT_BUILTIN_CLZLL(n) __builtin_clzll(n)</span>
<span class="cp">#endif</span>

<span class="c1">// Some compilers masquerade as both MSVC and GCC-likes or otherwise support</span>
<span class="c1">// __builtin_clz and __builtin_clzll, so only define FMT_BUILTIN_CLZ using the</span>
<span class="c1">// MSVC intrinsics if the clz and clzll builtins are not available.</span>
<span class="cp">#if FMT_MSC_VER &amp;&amp; !defined(FMT_BUILTIN_CLZLL) &amp;&amp; !defined(_MANAGED)</span>
<span class="cp">#include</span> <span class="cpf">&lt;intrin.h&gt; // _BitScanReverse, _BitScanReverse64</span><span class="cp"></span>

<span class="n">FMT_BEGIN_NAMESPACE</span>
<span class="k">namespace</span> <span class="n">internal</span> <span class="p">{</span>
<span class="c1">// Avoid Clang with Microsoft CodeGen&#39;s -Wunknown-pragmas warning.</span>
<span class="cp">#ifndef __clang__</span>
<span class="cp">#pragma intrinsic(_BitScanReverse)</span>
<span class="cp">#endif</span>
<span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="n">clz</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">_BitScanReverse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>

  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  <span class="c1">// Static analysis complains about using uninitialized data</span>
  <span class="c1">// &quot;r&quot;, but the only way that can happen is if &quot;x&quot; is 0,</span>
  <span class="c1">// which the callers guarantee to not happen.</span>
<span class="cp">#pragma warning(suppress : 6102)</span>
  <span class="k">return</span> <span class="mi">31</span> <span class="o">-</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define FMT_BUILTIN_CLZ(n) internal::clz(n)</span>

<span class="cp">#if defined(_WIN64) &amp;&amp; !defined(__clang__)</span>
<span class="cp">#pragma intrinsic(_BitScanReverse64)</span>
<span class="cp">#endif</span>

<span class="kr">inline</span> <span class="kt">uint32_t</span> <span class="n">clzll</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef _WIN64</span>
  <span class="n">_BitScanReverse64</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
<span class="cp">#else</span>
  <span class="c1">// Scan the high 32 bits.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">_BitScanReverse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)))</span>
    <span class="k">return</span> <span class="mi">63</span> <span class="o">-</span> <span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="mi">32</span><span class="p">);</span>

  <span class="c1">// Scan the low 32 bits.</span>
  <span class="n">_BitScanReverse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
<span class="cp">#endif</span>

  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">x</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  <span class="c1">// Static analysis complains about using uninitialized data</span>
  <span class="c1">// &quot;r&quot;, but the only way that can happen is if &quot;x&quot; is 0,</span>
  <span class="c1">// which the callers guarantee to not happen.</span>
<span class="cp">#pragma warning(suppress : 6102)</span>
  <span class="k">return</span> <span class="mi">63</span> <span class="o">-</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#define FMT_BUILTIN_CLZLL(n) internal::clzll(n)</span>
<span class="p">}</span> <span class="c1">// namespace internal</span>
<span class="n">FMT_END_NAMESPACE</span>
<span class="cp">#endif</span>

<span class="c1">// Enable the deprecated numeric alignment.</span>
<span class="cp">#ifndef FMT_NUMERIC_ALIGN</span>
<span class="cp">#define FMT_NUMERIC_ALIGN 1</span>
<span class="cp">#endif</span>

<span class="c1">// Enable the deprecated percent specifier.</span>
<span class="cp">#ifndef FMT_DEPRECATED_PERCENT</span>
<span class="cp">#define FMT_DEPRECATED_PERCENT 0</span>
<span class="cp">#endif</span>

<span class="n">FMT_BEGIN_NAMESPACE</span>
<span class="k">namespace</span> <span class="n">internal</span> <span class="p">{</span>

<span class="c1">// A helper function to suppress bogus &quot;conditional expression is constant&quot;</span>
<span class="c1">// warnings.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">T</span> <span class="n">const_check</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">value</span><span class="p">;</span> <span class="p">}</span>

<span class="c1">// An equivalent of `*reinterpret_cast&lt;Dest*&gt;(&amp;source)` that doesn&#39;t have</span>
<span class="c1">// undefined behavior (e.g. due to type aliasing).</span>
<span class="c1">// Example: uint64_t d = bit_cast&lt;uint64_t&gt;(2.718);</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Dest</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Source</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">Dest</span> <span class="n">bit_cast</span><span class="p">(</span><span class="k">const</span> <span class="n">Source</span> <span class="o">&amp;</span><span class="n">source</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">static_assert</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Dest</span><span class="p">)</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Source</span><span class="p">),</span> <span class="s">&quot;size mismatch&quot;</span><span class="p">);</span>
  <span class="n">Dest</span> <span class="n">dest</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dest</span><span class="p">));</span>
  <span class="k">return</span> <span class="n">dest</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">bool</span> <span class="n">is_big_endian</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">u</span> <span class="o">=</span> <span class="mi">1u</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">bytes</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u</span><span class="p">)];</span>
  <span class="p">};</span>
  <span class="k">return</span> <span class="n">bit_cast</span><span class="o">&lt;</span><span class="n">bytes</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">).</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// A fallback implementation of uintptr_t for systems that lack it.</span>
<span class="k">struct</span> <span class="n">fallback_uintptr</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)];</span>

  <span class="n">fallback_uintptr</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="k">explicit</span> <span class="nf">fallback_uintptr</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="k">this</span> <span class="o">=</span> <span class="n">bit_cast</span><span class="o">&lt;</span><span class="n">fallback_uintptr</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_big_endian</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">--</span><span class="n">j</span><span class="p">)</span>
        <span class="n">std</span><span class="o">::</span><span class="n">swap</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">value</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#ifdef UINTPTR_MAX</span>
<span class="k">using</span> <span class="kt">uintptr_t</span> <span class="o">=</span> <span class="o">::</span><span class="kt">uintptr_t</span><span class="p">;</span>
<span class="kr">inline</span> <span class="kt">uintptr_t</span> <span class="nf">to_uintptr</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">bit_cast</span><span class="o">&lt;</span><span class="kt">uintptr_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">);</span> <span class="p">}</span>
<span class="cp">#else</span>
<span class="k">using</span> <span class="kt">uintptr_t</span> <span class="o">=</span> <span class="n">fallback_uintptr</span><span class="p">;</span>
<span class="kr">inline</span> <span class="n">fallback_uintptr</span> <span class="nf">to_uintptr</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">fallback_uintptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="c1">// Returns the largest possible value for type T. Same as</span>
<span class="c1">// std::numeric_limits&lt;T&gt;::max() but shorter and not affected by the max macro.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">constexpr</span> <span class="n">T</span> <span class="n">max_value</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">max</span><span class="p">)();</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">num_bits</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">digits</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">num_bits</span><span class="o">&lt;</span><span class="n">fallback_uintptr</span><span class="o">&gt;</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">*</span>
                          <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;::</span><span class="n">digits</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// An approximation of iterator_t for pre-C++20 systems.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">iterator_t</span> <span class="o">=</span> <span class="k">decltype</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">declval</span><span class="o">&lt;</span><span class="n">T</span> <span class="o">&amp;&gt;</span><span class="p">()));</span>

<span class="c1">// Detect the iterator category of *any* given type in a SFINAE-friendly way.</span>
<span class="c1">// Unfortunately, older implementations of std::iterator_traits are not safe</span>
<span class="c1">// for use in a SFINAE-context.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Enable</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nl">iterator_category</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">false_type</span> <span class="p">{};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">iterator_category</span><span class="o">&lt;</span><span class="n">T</span> <span class="o">*&gt;</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">random_access_iterator_tag</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">iterator_category</span><span class="o">&lt;</span><span class="n">It</span><span class="p">,</span> <span class="n">void_t</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">::</span><span class="n">iterator_category</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">It</span><span class="o">::</span><span class="n">iterator_category</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Detect if *any* given type models the OutputIterator concept.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">is_output_iterator</span> <span class="p">{</span>
  <span class="c1">// Check for mutability because all iterator categories derived from</span>
  <span class="c1">// std::input_iterator_tag *may* also meet the requirements of an</span>
  <span class="c1">// OutputIterator, thereby falling into the category of &#39;mutable iterators&#39;</span>
  <span class="c1">// [iterator.requirements.general] clause 4. The compiler reveals this</span>
  <span class="c1">// property only at the point of *actually dereferencing* the iterator!</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
  <span class="k">static</span> <span class="k">decltype</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">declval</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">()))</span> <span class="n">test</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">input_iterator_tag</span><span class="p">);</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span> <span class="k">static</span> <span class="kt">char</span> <span class="o">&amp;</span><span class="n">test</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">output_iterator_tag</span><span class="p">);</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span> <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">&amp;</span><span class="n">test</span><span class="p">(...);</span>

  <span class="k">using</span> <span class="n">type</span> <span class="o">=</span> <span class="k">decltype</span><span class="p">(</span><span class="n">test</span><span class="o">&lt;</span><span class="n">It</span><span class="o">&gt;</span><span class="p">(</span><span class="k">typename</span> <span class="n">iterator_category</span><span class="o">&lt;</span><span class="n">It</span><span class="o">&gt;::</span><span class="n">type</span><span class="p">{}));</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">bool</span> <span class="n">value</span> <span class="o">=</span> <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_const</span><span class="o">&lt;</span><span class="n">remove_reference_t</span><span class="o">&lt;</span><span class="n">type</span><span class="o">&gt;&gt;::</span><span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// A workaround for std::string not having mutable data() until C++17.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">Char</span> <span class="o">*</span><span class="n">get_data</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Container</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="k">typename</span> <span class="n">Container</span><span class="o">::</span><span class="n">value_type</span> <span class="o">*</span><span class="n">get_data</span><span class="p">(</span><span class="n">Container</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">c</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#ifdef _SECURE_SCL</span>
<span class="c1">// Make a checked iterator to avoid MSVC warnings.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">checked_ptr</span> <span class="o">=</span> <span class="n">stdext</span><span class="o">::</span><span class="n">checked_array_iterator</span><span class="o">&lt;</span><span class="n">T</span> <span class="o">*&gt;</span><span class="p">;</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">checked_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">make_checked</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">};</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">using</span> <span class="n">checked_ptr</span> <span class="o">=</span> <span class="n">T</span> <span class="o">*</span><span class="p">;</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">T</span> <span class="o">*</span><span class="n">make_checked</span><span class="p">(</span><span class="n">T</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">p</span><span class="p">;</span> <span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Container</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">is_contiguous</span><span class="o">&lt;</span><span class="n">Container</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">checked_ptr</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Container</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;</span>
<span class="n">reserve</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">back_insert_iterator</span><span class="o">&lt;</span><span class="n">Container</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">it</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Container</span> <span class="o">&amp;</span><span class="n">c</span> <span class="o">=</span> <span class="n">get_container</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="n">c</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
  <span class="k">return</span> <span class="nf">make_checked</span><span class="p">(</span><span class="n">get_data</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Iterator</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">Iterator</span> <span class="o">&amp;</span><span class="n">reserve</span><span class="p">(</span><span class="n">Iterator</span> <span class="o">&amp;</span><span class="n">it</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// An output iterator that counts the number of objects written to it and</span>
<span class="c1">// discards them.</span>
<span class="k">class</span> <span class="nc">counting_iterator</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">count_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">iterator_category</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">output_iterator_tag</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">difference_type</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="kt">ptrdiff_t</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">pointer</span> <span class="o">=</span> <span class="kt">void</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">reference</span> <span class="o">=</span> <span class="kt">void</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">_Unchecked_type</span> <span class="o">=</span> <span class="n">counting_iterator</span><span class="p">;</span> <span class="c1">// Mark iterator as checked.</span>

  <span class="k">struct</span> <span class="n">value_type</span> <span class="p">{</span>
    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="p">)</span> <span class="p">{}</span>
  <span class="p">};</span>

  <span class="n">counting_iterator</span><span class="p">()</span> <span class="o">:</span> <span class="n">count_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">count</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">count_</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">counting_iterator</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">++</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">count_</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">counting_iterator</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="o">++*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">value_type</span> <span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{};</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">truncating_iterator_base</span> <span class="p">{</span>
<span class="k">protected</span><span class="o">:</span>
  <span class="n">OutputIt</span> <span class="n">out_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">limit_</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">count_</span><span class="p">;</span>

  <span class="n">truncating_iterator_base</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">out</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">limit</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">out_</span><span class="p">(</span><span class="n">out</span><span class="p">),</span> <span class="n">limit_</span><span class="p">(</span><span class="n">limit</span><span class="p">),</span> <span class="n">count_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">iterator_category</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">output_iterator_tag</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">difference_type</span> <span class="o">=</span> <span class="kt">void</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">pointer</span> <span class="o">=</span> <span class="kt">void</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">reference</span> <span class="o">=</span> <span class="kt">void</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">_Unchecked_type</span> <span class="o">=</span> <span class="n">truncating_iterator_base</span><span class="p">;</span> <span class="c1">// Mark iterator as checked.</span>

  <span class="n">OutputIt</span> <span class="nf">base</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">out_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">count</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">count_</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// An output iterator that truncates the output and counts the number of objects</span>
<span class="c1">// written to it.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span>
          <span class="k">typename</span> <span class="n">Enable</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">is_void</span><span class="o">&lt;</span>
              <span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">truncating_iterator</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">truncating_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">false_type</span><span class="o">&gt;</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">truncating_iterator_base</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">traits</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="k">mutable</span> <span class="k">typename</span> <span class="n">traits</span><span class="o">::</span><span class="n">value_type</span> <span class="n">blackhole_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">value_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">traits</span><span class="o">::</span><span class="n">value_type</span><span class="p">;</span>

  <span class="n">truncating_iterator</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">out</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">limit</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">truncating_iterator_base</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">truncating_iterator</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">++</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">count_</span><span class="o">++</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">limit_</span><span class="p">)</span>
      <span class="o">++</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">out_</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">truncating_iterator</span> <span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
    <span class="o">++*</span><span class="k">this</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">value_type</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">count_</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">limit_</span> <span class="o">?</span> <span class="o">*</span><span class="k">this</span><span class="o">-&gt;</span><span class="nl">out_</span> <span class="p">:</span> <span class="n">blackhole_</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">truncating_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span><span class="o">&gt;</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">truncating_iterator_base</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">value_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">OutputIt</span><span class="o">::</span><span class="n">container_type</span><span class="o">::</span><span class="n">value_type</span><span class="p">;</span>

  <span class="n">truncating_iterator</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">out</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">limit</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">truncating_iterator_base</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">limit</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">truncating_iterator</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">value_type</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">count_</span><span class="o">++</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">limit_</span><span class="p">)</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">out_</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">truncating_iterator</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">++</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">truncating_iterator</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">++</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">truncating_iterator</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">*</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// A range with the specified output iterator and value type.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">OutputIt</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">output_range</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">OutputIt</span> <span class="n">it_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">value_type</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">OutputIt</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">sentinel</span> <span class="p">{};</span>

  <span class="k">explicit</span> <span class="nf">output_range</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">it</span><span class="p">)</span> <span class="o">:</span> <span class="n">it_</span><span class="p">(</span><span class="n">it</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">OutputIt</span> <span class="nf">begin</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">it_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">sentinel</span> <span class="nf">end</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{};</span> <span class="p">}</span> <span class="c1">// Sentinel is not used yet.</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">size_t</span> <span class="n">count_code_points</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Counts the number of code points in a UTF-8 string.</span>
<span class="kr">inline</span> <span class="kt">size_t</span> <span class="n">count_code_points</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="kt">char8_t</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char8_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="kt">size_t</span> <span class="n">num_code_points</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span>
      <span class="o">++</span><span class="n">num_code_points</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">num_code_points</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="kt">size_t</span> <span class="n">code_point_index</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">?</span> <span class="nl">n</span> <span class="p">:</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Calculates the index of the nth code point in a UTF-8 string.</span>
<span class="kr">inline</span> <span class="kt">size_t</span> <span class="n">code_point_index</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="kt">char8_t</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="kt">char8_t</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="kt">size_t</span> <span class="n">num_code_points</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">num_code_points</span> <span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="p">}</span>

<span class="kr">inline</span> <span class="kt">char8_t</span> <span class="n">to_char8_t</span><span class="p">(</span><span class="kt">char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">c</span><span class="p">);</span> <span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">InputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">OutChar</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">needs_conversion</span> <span class="o">=</span> <span class="n">bool_constant</span><span class="o">&lt;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">InputIt</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span>
                 <span class="kt">char</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">OutChar</span><span class="p">,</span> <span class="kt">char8_t</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutChar</span><span class="p">,</span> <span class="k">typename</span> <span class="n">InputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span>
          <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="o">!</span><span class="n">needs_conversion</span><span class="o">&lt;</span><span class="n">InputIt</span><span class="p">,</span> <span class="n">OutChar</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">OutputIt</span> <span class="n">copy_str</span><span class="p">(</span><span class="n">InputIt</span> <span class="n">begin</span><span class="p">,</span> <span class="n">InputIt</span> <span class="n">end</span><span class="p">,</span> <span class="n">OutputIt</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutChar</span><span class="p">,</span> <span class="k">typename</span> <span class="n">InputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span>
          <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">needs_conversion</span><span class="o">&lt;</span><span class="n">InputIt</span><span class="p">,</span> <span class="n">OutChar</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">OutputIt</span> <span class="n">copy_str</span><span class="p">(</span><span class="n">InputIt</span> <span class="n">begin</span><span class="p">,</span> <span class="n">InputIt</span> <span class="n">end</span><span class="p">,</span> <span class="n">OutputIt</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">transform</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">it</span><span class="p">,</span> <span class="n">to_char8_t</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef FMT_USE_GRISU</span>
<span class="cp">#define FMT_USE_GRISU 1</span>
<span class="cp">#endif</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">constexpr</span> <span class="kt">bool</span> <span class="n">use_grisu</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">FMT_USE_GRISU</span> <span class="o">&amp;&amp;</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;::</span><span class="n">is_iec559</span> <span class="o">&amp;&amp;</span>
         <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">append</span><span class="p">(</span><span class="k">const</span> <span class="n">U</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">U</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">new_size</span> <span class="o">=</span> <span class="n">size_</span> <span class="o">+</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>
  <span class="n">reserve</span><span class="p">(</span><span class="n">new_size</span><span class="p">);</span>
  <span class="n">std</span><span class="o">::</span><span class="n">uninitialized_copy</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">make_checked</span><span class="p">(</span><span class="n">ptr_</span><span class="p">,</span> <span class="n">capacity_</span><span class="p">)</span> <span class="o">+</span> <span class="n">size_</span><span class="p">);</span>
  <span class="n">size_</span> <span class="o">=</span> <span class="n">new_size</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace internal</span>

<span class="c1">// A range with an iterator appending to a buffer.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">buffer_range</span> <span class="o">:</span> <span class="k">public</span> <span class="n">internal</span><span class="o">::</span><span class="n">output_range</span><span class="o">&lt;</span>
                         <span class="n">std</span><span class="o">::</span><span class="n">back_insert_iterator</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">back_insert_iterator</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">internal</span><span class="o">::</span><span class="n">output_range</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;::</span><span class="n">output_range</span><span class="p">;</span>
  <span class="n">buffer_range</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">internal</span><span class="o">::</span><span class="n">output_range</span><span class="o">&lt;</span><span class="n">iterator</span><span class="p">,</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">back_inserter</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="c1">// A UTF-8 string view.</span>
<span class="k">class</span> <span class="nc">u8string_view</span> <span class="o">:</span> <span class="k">public</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="kt">char8_t</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">u8string_view</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="kt">char8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char8_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{}</span>
  <span class="n">u8string_view</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span> <span class="nl">FMT_NOEXCEPT</span>
      <span class="p">:</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="kt">char8_t</span><span class="o">&gt;</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char8_t</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">),</span>
                                   <span class="n">count</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="cp">#if FMT_USE_USER_DEFINED_LITERALS</span>
<span class="kr">inline</span> <span class="k">namespace</span> <span class="n">literals</span> <span class="p">{</span>
<span class="kr">inline</span> <span class="n">u8string_view</span> <span class="k">operator</span><span class="s">&quot;&quot;</span> <span class="n">_u</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">};</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace literals</span>
<span class="cp">#endif</span>

<span class="c1">// The number of characters to store in the basic_memory_buffer object itself</span>
<span class="c1">// to avoid dynamic memory allocation.</span>
<span class="k">enum</span> <span class="p">{</span> <span class="n">inline_buffer_size</span> <span class="o">=</span> <span class="mi">500</span> <span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="n">inline_buffer_size</span><span class="p">,</span>
          <span class="k">typename</span> <span class="n">Allocator</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;&gt;</span>
<span class="k">class</span> <span class="nc">basic_memory_buffer</span> <span class="o">:</span> <span class="k">private</span> <span class="n">Allocator</span><span class="p">,</span> <span class="k">public</span> <span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">T</span> <span class="n">store_</span><span class="p">[</span><span class="n">SIZE</span><span class="p">];</span>

  <span class="c1">// Deallocate memory allocated by the buffer.</span>
  <span class="kt">void</span> <span class="nf">deallocate</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">T</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">store_</span><span class="p">)</span>
      <span class="n">Allocator</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">());</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">grow</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="n">FMT_OVERRIDE</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">value_type</span> <span class="o">=</span> <span class="n">T</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">const_reference</span> <span class="o">=</span> <span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="p">;</span>

  <span class="k">explicit</span> <span class="nf">basic_memory_buffer</span><span class="p">(</span><span class="k">const</span> <span class="n">Allocator</span> <span class="o">&amp;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">Allocator</span><span class="p">())</span>
      <span class="o">:</span> <span class="n">Allocator</span><span class="p">(</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">store_</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">basic_memory_buffer</span><span class="p">()</span> <span class="n">FMT_OVERRIDE</span> <span class="p">{</span> <span class="n">deallocate</span><span class="p">();</span> <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="c1">// Move data from other to this buffer.</span>
  <span class="kt">void</span> <span class="n">move</span><span class="p">(</span><span class="n">basic_memory_buffer</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Allocator</span> <span class="o">&amp;</span><span class="n">this_alloc</span> <span class="o">=</span> <span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">other_alloc</span> <span class="o">=</span> <span class="n">other</span><span class="p">;</span>
    <span class="n">this_alloc</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">other_alloc</span><span class="p">);</span>
    <span class="n">T</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">capacity</span> <span class="o">=</span> <span class="n">other</span><span class="p">.</span><span class="n">capacity</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">store_</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">store_</span><span class="p">,</span> <span class="n">capacity</span><span class="p">);</span>
      <span class="n">std</span><span class="o">::</span><span class="n">uninitialized_copy</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">store_</span><span class="p">,</span> <span class="n">other</span><span class="p">.</span><span class="n">store_</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span>
                              <span class="n">internal</span><span class="o">::</span><span class="n">make_checked</span><span class="p">(</span><span class="n">store_</span><span class="p">,</span> <span class="n">capacity</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">capacity</span><span class="p">);</span>
      <span class="c1">// Set pointer to the inline array so that delete is not called</span>
      <span class="c1">// when deallocating.</span>
      <span class="n">other</span><span class="p">.</span><span class="n">set</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">store_</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">basic_memory_buffer</span><span class="p">(</span><span class="n">basic_memory_buffer</span> <span class="o">&amp;&amp;</span><span class="n">other</span><span class="p">)</span> <span class="n">FMT_NOEXCEPT</span> <span class="p">{</span> <span class="n">move</span><span class="p">(</span><span class="n">other</span><span class="p">);</span> <span class="p">}</span>

  <span class="n">basic_memory_buffer</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">basic_memory_buffer</span> <span class="o">&amp;&amp;</span><span class="n">other</span><span class="p">)</span> <span class="n">FMT_NOEXCEPT</span> <span class="p">{</span>
    <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="k">this</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="n">deallocate</span><span class="p">();</span>
    <span class="n">move</span><span class="p">(</span><span class="n">other</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Returns a copy of the allocator associated with this buffer.</span>
  <span class="n">Allocator</span> <span class="n">get_allocator</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">SIZE</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Allocator</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">basic_memory_buffer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">SIZE</span><span class="p">,</span> <span class="n">Allocator</span><span class="o">&gt;::</span><span class="n">grow</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;fuzz mode - won&#39;t grow that much&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">old_capacity</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">capacity</span><span class="p">();</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">new_capacity</span> <span class="o">=</span> <span class="n">old_capacity</span> <span class="o">+</span> <span class="n">old_capacity</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">new_capacity</span><span class="p">)</span>
    <span class="n">new_capacity</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
  <span class="n">T</span> <span class="o">*</span><span class="n">old_data</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">();</span>
  <span class="n">T</span> <span class="o">*</span><span class="n">new_data</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">allocator_traits</span><span class="o">&lt;</span><span class="n">Allocator</span><span class="o">&gt;::</span><span class="n">allocate</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">new_capacity</span><span class="p">);</span>
  <span class="c1">// The following code doesn&#39;t throw, so the raw pointer above doesn&#39;t leak.</span>
  <span class="n">std</span><span class="o">::</span><span class="n">uninitialized_copy</span><span class="p">(</span><span class="n">old_data</span><span class="p">,</span> <span class="n">old_data</span> <span class="o">+</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">(),</span>
                          <span class="n">internal</span><span class="o">::</span><span class="n">make_checked</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">new_capacity</span><span class="p">));</span>
  <span class="k">this</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">new_data</span><span class="p">,</span> <span class="n">new_capacity</span><span class="p">);</span>
  <span class="c1">// deallocate must not throw according to the standard, but even if it does,</span>
  <span class="c1">// the buffer already uses the new storage and will deallocate it in</span>
  <span class="c1">// destructor.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">old_data</span> <span class="o">!=</span> <span class="n">store_</span><span class="p">)</span>
    <span class="n">Allocator</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">old_data</span><span class="p">,</span> <span class="n">old_capacity</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">using</span> <span class="n">memory_buffer</span> <span class="o">=</span> <span class="n">basic_memory_buffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span> <span class="n">wmemory_buffer</span> <span class="o">=</span> <span class="n">basic_memory_buffer</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">FMT_API</span> <span class="nl">format_error</span> <span class="p">:</span> <span class="k">public</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">format_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{}</span>
  <span class="k">explicit</span> <span class="n">format_error</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">message</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">format_error</span><span class="p">(</span><span class="k">const</span> <span class="n">format_error</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">format_error</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">format_error</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">format_error</span><span class="p">(</span><span class="n">format_error</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">format_error</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">format_error</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="o">~</span><span class="n">format_error</span><span class="p">()</span> <span class="n">FMT_NOEXCEPT</span> <span class="n">FMT_OVERRIDE</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">namespace</span> <span class="n">internal</span> <span class="p">{</span>

<span class="c1">// Returns true if value is negative, false otherwise.</span>
<span class="c1">// Same as `value &lt; 0` but doesn&#39;t produce warnings if T is an unsigned type.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is_signed</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">bool</span> <span class="n">is_negative</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">is_signed</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">bool</span> <span class="n">is_negative</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Smallest of uint32_t, uint64_t, uint128_t that is large enough to</span>
<span class="c1">// represent all values of T.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">uint32_or_64_or_128_t</span> <span class="o">=</span> <span class="n">conditional_t</span><span class="o">&lt;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">digits</span> <span class="o">&lt;=</span> <span class="mi">32</span><span class="p">,</span> <span class="kt">uint32_t</span><span class="p">,</span>
    <span class="n">conditional_t</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">digits</span> <span class="o">&lt;=</span> <span class="mi">64</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="p">,</span> <span class="n">uint128_t</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="c1">// Static data is placed in this class template for the header-only config.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">FMT_EXTERN_TEMPLATE_API</span> <span class="n">basic_data</span> <span class="p">{</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">powers_of_10_64</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">uint32_t</span> <span class="n">zero_or_powers_of_10_32</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">zero_or_powers_of_10_64</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">pow10_significands</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">int16_t</span> <span class="n">pow10_exponents</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">digits</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">hex_digits</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">foreground_color</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">background_color</span><span class="p">[];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">reset_color</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">wchar_t</span> <span class="n">wreset_color</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
  <span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">signs</span><span class="p">[];</span>
<span class="p">};</span>

<span class="n">FMT_EXTERN</span> <span class="k">template</span> <span class="k">struct</span> <span class="n">basic_data</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">;</span>

<span class="c1">// This is a struct rather than an alias to avoid shadowing warnings in gcc.</span>
<span class="k">struct</span> <span class="nl">data</span> <span class="p">:</span> <span class="n">basic_data</span><span class="o">&lt;&gt;</span> <span class="p">{};</span>

<span class="cp">#ifdef FMT_BUILTIN_CLZLL</span>
<span class="c1">// Returns the number of decimal digits in n. Leading zeros are not counted</span>
<span class="c1">// except for n == 0 in which case count_digits returns 1.</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">count_digits</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Based on http://graphics.stanford.edu/~seander/bithacks.html#IntegerLog10</span>
  <span class="c1">// and the benchmark https://github.com/localvoid/cxx-benchmark-count-digits.</span>
  <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">FMT_BUILTIN_CLZLL</span><span class="p">(</span><span class="n">n</span> <span class="o">|</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1233</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">::</span><span class="n">zero_or_powers_of_10_64</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="c1">// Fallback version of count_digits used when __builtin_clz is not available.</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">count_digits</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="c1">// Integer division is slow so do it for a group of four digits instead</span>
    <span class="c1">// of for every digit. The idea comes from the talk by Alexandrescu</span>
    <span class="c1">// &quot;Three Optimization Tips for C++&quot;. See speed-test for a comparison.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">n</span> <span class="o">/=</span> <span class="mi">10000u</span><span class="p">;</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#if FMT_USE_INT128</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">count_digits</span><span class="p">(</span><span class="n">uint128_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="c1">// Integer division is slow so do it for a group of four digits instead</span>
    <span class="c1">// of for every digit. The idea comes from the talk by Alexandrescu</span>
    <span class="c1">// &quot;Three Optimization Tips for C++&quot;. See speed-test for a comparison.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">n</span> <span class="o">/=</span> <span class="mi">10000U</span><span class="p">;</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="c1">// Counts the number of digits in n. BITS = log2(radix).</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="kt">unsigned</span> <span class="n">BITS</span><span class="p">,</span> <span class="k">typename</span> <span class="n">UInt</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">count_digits</span><span class="p">(</span><span class="n">UInt</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">num_digits</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="n">BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">num_digits</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="kt">int</span> <span class="n">count_digits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">fallback_uintptr</span> <span class="n">n</span><span class="p">);</span>

<span class="cp">#if FMT_GCC_VERSION || FMT_CLANG_VERSION</span>
<span class="cp">#define FMT_ALWAYS_INLINE inline __attribute__((always_inline))</span>
<span class="cp">#else</span>
<span class="cp">#define FMT_ALWAYS_INLINE</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef FMT_BUILTIN_CLZ</span>
<span class="c1">// Optional version of count_digits for better performance on 32-bit platforms.</span>
<span class="kr">inline</span> <span class="kt">int</span> <span class="nf">count_digits</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">FMT_BUILTIN_CLZ</span><span class="p">(</span><span class="n">n</span> <span class="o">|</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">1233</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">t</span> <span class="o">-</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">::</span><span class="n">zero_or_powers_of_10_32</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="n">FMT_API</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">grouping_impl</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">);</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">grouping</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">grouping_impl</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">loc</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">grouping</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">grouping_impl</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">loc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="n">FMT_API</span> <span class="n">Char</span> <span class="n">thousands_sep_impl</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">);</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">Char</span> <span class="n">thousands_sep</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Char</span><span class="p">(</span><span class="n">thousands_sep_impl</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">loc</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="kr">inline</span> <span class="kt">wchar_t</span> <span class="n">thousands_sep</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">thousands_sep_impl</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">loc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="n">FMT_API</span> <span class="n">Char</span> <span class="n">decimal_point_impl</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">);</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">Char</span> <span class="n">decimal_point</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Char</span><span class="p">(</span><span class="n">decimal_point_impl</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">loc</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="kr">inline</span> <span class="kt">wchar_t</span> <span class="n">decimal_point</span><span class="p">(</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">decimal_point_impl</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">loc</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// Formats a decimal unsigned integer value writing into buffer.</span>
<span class="c1">// add_thousands_sep is called after writing each char to add a thousands</span>
<span class="c1">// separator if necessary.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">UInt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">Char</span> <span class="o">*</span><span class="n">format_decimal</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">UInt</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_digits</span><span class="p">,</span>
                            <span class="n">F</span> <span class="n">add_thousands_sep</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">num_digits</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;invalid digit count&quot;</span><span class="p">);</span>
  <span class="n">buffer</span> <span class="o">+=</span> <span class="n">num_digits</span><span class="p">;</span>
  <span class="n">Char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Integer division is slow so do it for a group of two digits instead</span>
    <span class="c1">// of for every digit. The idea comes from the talk by Alexandrescu</span>
    <span class="c1">// &quot;Three Optimization Tips for C++&quot;. See speed-test for a comparison.</span>
    <span class="k">auto</span> <span class="n">index</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">((</span><span class="n">value</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
    <span class="n">value</span> <span class="o">/=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="o">*--</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
    <span class="n">add_thousands_sep</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="o">*--</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
    <span class="n">add_thousands_sep</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*--</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">end</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">auto</span> <span class="n">index</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
  <span class="o">*--</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
  <span class="n">add_thousands_sep</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
  <span class="o">*--</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">end</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Int</span><span class="o">&gt;</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">digits10</span><span class="p">()</span> <span class="k">noexcept</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="n">Int</span><span class="o">&gt;::</span><span class="n">digits10</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">digits10</span><span class="o">&lt;</span><span class="n">int128_t</span><span class="o">&gt;</span><span class="p">()</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">38</span><span class="p">;</span> <span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="k">constexpr</span> <span class="kt">int</span> <span class="n">digits10</span><span class="o">&lt;</span><span class="n">uint128_t</span><span class="o">&gt;</span><span class="p">()</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">38</span><span class="p">;</span> <span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">UInt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Iterator</span><span class="p">,</span> <span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">Iterator</span> <span class="n">format_decimal</span><span class="p">(</span><span class="n">Iterator</span> <span class="n">out</span><span class="p">,</span> <span class="n">UInt</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_digits</span><span class="p">,</span>
                               <span class="n">F</span> <span class="n">add_thousands_sep</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">num_digits</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;invalid digit count&quot;</span><span class="p">);</span>
  <span class="c1">// Buffer should be large enough to hold all digits (&lt;= digits10 + 1).</span>
  <span class="k">enum</span> <span class="p">{</span> <span class="n">max_size</span> <span class="o">=</span> <span class="n">digits10</span><span class="o">&lt;</span><span class="n">UInt</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">};</span>
  <span class="n">Char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">max_size</span><span class="p">];</span>
  <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">format_decimal</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">,</span> <span class="n">add_thousands_sep</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">It</span><span class="p">,</span> <span class="k">typename</span> <span class="n">UInt</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">It</span> <span class="n">format_decimal</span><span class="p">(</span><span class="n">It</span> <span class="n">out</span><span class="p">,</span> <span class="n">UInt</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_digits</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">format_decimal</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">,</span> <span class="p">[](</span><span class="n">Char</span> <span class="o">*</span><span class="p">)</span> <span class="p">{});</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">unsigned</span> <span class="n">BASE_BITS</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">UInt</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">Char</span> <span class="o">*</span><span class="n">format_uint</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">UInt</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_digits</span><span class="p">,</span>
                         <span class="kt">bool</span> <span class="n">upper</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">buffer</span> <span class="o">+=</span> <span class="n">num_digits</span><span class="p">;</span>
  <span class="n">Char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">digits</span> <span class="o">=</span> <span class="n">upper</span> <span class="o">?</span> <span class="s">&quot;0123456789ABCDEF&quot;</span> <span class="o">:</span> <span class="n">data</span><span class="o">::</span><span class="n">hex_digits</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="n">digit</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BASE_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
    <span class="o">*--</span><span class="n">buffer</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BASE_BITS</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">digit</span><span class="p">)</span>
                                                <span class="o">:</span> <span class="n">digits</span><span class="p">[</span><span class="n">digit</span><span class="p">]);</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="n">BASE_BITS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">end</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">unsigned</span> <span class="n">BASE_BITS</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="n">Char</span> <span class="o">*</span><span class="n">format_uint</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">fallback_uintptr</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_digits</span><span class="p">,</span>
                  <span class="kt">bool</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">char_digits</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">&gt;::</span><span class="n">digits</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">num_digits</span> <span class="o">+</span> <span class="n">char_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">char_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="kt">int</span> <span class="n">start_digits</span> <span class="o">=</span> <span class="n">num_digits</span> <span class="o">%</span> <span class="n">char_digits</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">value</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">start</span><span class="o">--</span><span class="p">];</span>
    <span class="n">buffer</span> <span class="o">=</span> <span class="n">format_uint</span><span class="o">&lt;</span><span class="n">BASE_BITS</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">start_digits</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">value</span> <span class="o">=</span> <span class="n">n</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">start</span><span class="p">];</span>
    <span class="n">buffer</span> <span class="o">+=</span> <span class="n">char_digits</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">char_digits</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="kt">unsigned</span> <span class="n">digit</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">BASE_BITS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
      <span class="o">*--</span><span class="n">p</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">hex_digits</span><span class="p">[</span><span class="n">digit</span><span class="p">]);</span>
      <span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="n">BASE_BITS</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">unsigned</span> <span class="n">BASE_BITS</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">It</span><span class="p">,</span> <span class="k">typename</span> <span class="n">UInt</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">It</span> <span class="n">format_uint</span><span class="p">(</span><span class="n">It</span> <span class="n">out</span><span class="p">,</span> <span class="n">UInt</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_digits</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">upper</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Buffer should be large enough to hold all digits (digits / BASE_BITS + 1).</span>
  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">num_bits</span><span class="o">&lt;</span><span class="n">UInt</span><span class="o">&gt;</span><span class="p">()</span> <span class="o">/</span> <span class="n">BASE_BITS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
  <span class="n">format_uint</span><span class="o">&lt;</span><span class="n">BASE_BITS</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">,</span> <span class="n">upper</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">num_digits</span><span class="p">,</span> <span class="n">out</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef _WIN32</span>
<span class="cp">#define FMT_USE_WINDOWS_H 0</span>
<span class="cp">#elif !defined(FMT_USE_WINDOWS_H)</span>
<span class="cp">#define FMT_USE_WINDOWS_H 1</span>
<span class="cp">#endif</span>

<span class="c1">// Define FMT_USE_WINDOWS_H to 0 to disable use of windows.h.</span>
<span class="c1">// All the functionality that relies on it will be disabled too.</span>
<span class="cp">#if FMT_USE_WINDOWS_H</span>
<span class="c1">// A converter from UTF-8 to UTF-16.</span>
<span class="c1">// It is only provided for Windows since other systems support UTF-8 natively.</span>
<span class="k">class</span> <span class="nc">utf8_to_utf16</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">wmemory_buffer</span> <span class="n">buffer_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">FMT_API</span> <span class="k">explicit</span> <span class="n">utf8_to_utf16</span><span class="p">(</span><span class="n">string_view</span> <span class="n">s</span><span class="p">);</span>
  <span class="k">operator</span> <span class="nf">wstring_view</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">wstring_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">());</span> <span class="p">}</span>
  <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">buffer_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="nf">c_str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">buffer_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">wstring</span> <span class="n">str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">());</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// A converter from UTF-16 to UTF-8.</span>
<span class="c1">// It is only provided for Windows since other systems support UTF-8 natively.</span>
<span class="k">class</span> <span class="nc">utf16_to_utf8</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">memory_buffer</span> <span class="n">buffer_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">utf16_to_utf8</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">FMT_API</span> <span class="k">explicit</span> <span class="n">utf16_to_utf8</span><span class="p">(</span><span class="n">wstring_view</span> <span class="n">s</span><span class="p">);</span>
  <span class="k">operator</span> <span class="nf">string_view</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">string_view</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">());</span> <span class="p">}</span>
  <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">buffer_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">c_str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="o">&amp;</span><span class="n">buffer_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="p">}</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">size</span><span class="p">());</span> <span class="p">}</span>

  <span class="c1">// Performs conversion returning a system error code instead of</span>
  <span class="c1">// throwing exception on conversion error. This method may still throw</span>
  <span class="c1">// in case of memory allocation error.</span>
  <span class="n">FMT_API</span> <span class="kt">int</span> <span class="n">convert</span><span class="p">(</span><span class="n">wstring_view</span> <span class="n">s</span><span class="p">);</span>
<span class="p">};</span>

<span class="n">FMT_API</span> <span class="kt">void</span> <span class="nf">format_windows_error</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span>
                                  <span class="n">string_view</span> <span class="n">message</span><span class="p">)</span> <span class="n">FMT_NOEXCEPT</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span> <span class="o">=</span> <span class="kt">void</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">null</span> <span class="p">{};</span>

<span class="c1">// Workaround an array initialization issue in gcc 4.8.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">fill_t</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">Char</span> <span class="n">data_</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="n">Char</span> <span class="o">&amp;</span><span class="k">operator</span><span class="p">[](</span><span class="kt">size_t</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">data_</span><span class="p">[</span><span class="n">index</span><span class="p">];</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">&amp;</span><span class="k">operator</span><span class="p">[](</span><span class="kt">size_t</span> <span class="n">index</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">data_</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
  <span class="p">}</span>

  <span class="k">static</span> <span class="n">FMT_CONSTEXPR</span> <span class="n">fill_t</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">make</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">fill_t</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Char</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">fill</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="p">}</span> <span class="c1">// namespace internal</span>

<span class="c1">// We cannot use enum classes as bit fields because of a gcc bug</span>
<span class="c1">// https://gcc.gnu.org/bugzilla/show_bug.cgi?id=61414.</span>
<span class="k">namespace</span> <span class="n">align</span> <span class="p">{</span>
<span class="k">enum</span> <span class="n">type</span> <span class="p">{</span> <span class="n">none</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">center</span><span class="p">,</span> <span class="n">numeric</span> <span class="p">};</span>
<span class="p">}</span>
<span class="k">using</span> <span class="n">align_t</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">type</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">sign</span> <span class="p">{</span>
<span class="k">enum</span> <span class="n">type</span> <span class="p">{</span> <span class="n">none</span><span class="p">,</span> <span class="n">minus</span><span class="p">,</span> <span class="n">plus</span><span class="p">,</span> <span class="n">space</span> <span class="p">};</span>
<span class="p">}</span>
<span class="k">using</span> <span class="n">sign_t</span> <span class="o">=</span> <span class="n">sign</span><span class="o">::</span><span class="n">type</span><span class="p">;</span>

<span class="c1">// Format specifiers for built-in and string types.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">basic_format_specs</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">precision</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">type</span><span class="p">;</span>
  <span class="n">align_t</span> <span class="nl">align</span> <span class="p">:</span> <span class="mi">4</span><span class="p">;</span>
  <span class="n">sign_t</span> <span class="nl">sign</span> <span class="p">:</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nl">alt</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Alternate form (&#39;#&#39;).</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">fill_t</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">fill</span><span class="p">;</span>

  <span class="k">constexpr</span> <span class="nf">basic_format_specs</span><span class="p">()</span>
      <span class="o">:</span> <span class="n">width</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">precision</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">type</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">align</span><span class="p">(</span><span class="n">align</span><span class="o">::</span><span class="n">none</span><span class="p">),</span> <span class="n">sign</span><span class="p">(</span><span class="n">sign</span><span class="o">::</span><span class="n">none</span><span class="p">),</span>
        <span class="n">alt</span><span class="p">(</span><span class="nb">false</span><span class="p">),</span> <span class="n">fill</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">fill_t</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;::</span><span class="n">make</span><span class="p">())</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="k">using</span> <span class="n">format_specs</span> <span class="o">=</span> <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">internal</span> <span class="p">{</span>

<span class="c1">// A floating-point presentation format.</span>
<span class="k">enum</span> <span class="k">class</span> <span class="nc">float_format</span> <span class="o">:</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="p">{</span>
  <span class="n">general</span><span class="p">,</span> <span class="c1">// General: exponent notation or fixed point based on magnitude.</span>
  <span class="n">exp</span><span class="p">,</span>     <span class="c1">// Exponent notation with the default precision of 6, e.g. 1.2e-3.</span>
  <span class="n">fixed</span><span class="p">,</span>   <span class="c1">// Fixed point with the default precision of 6, e.g. 0.0012.</span>
  <span class="n">hex</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">float_specs</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">precision</span><span class="p">;</span>
  <span class="n">float_format</span> <span class="nl">format</span> <span class="p">:</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">sign_t</span> <span class="nl">sign</span> <span class="p">:</span> <span class="mi">8</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nl">upper</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nl">locale</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nl">percent</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nl">binary32</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nl">use_grisu</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="nl">trailing_zeros</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Writes the exponent exp in the form &quot;[+-]d{2,3}&quot; to buffer.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="n">It</span> <span class="n">write_exponent</span><span class="p">(</span><span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="n">It</span> <span class="n">it</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="o">-</span><span class="mi">10000</span> <span class="o">&lt;</span> <span class="n">exp</span> <span class="o">&amp;&amp;</span> <span class="n">exp</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">,</span> <span class="s">&quot;exponent out of range&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="o">-</span><span class="n">exp</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;+&#39;</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">data</span><span class="o">::</span><span class="n">digits</span> <span class="o">+</span> <span class="p">(</span><span class="n">exp</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">exp</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">top</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">top</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="n">exp</span> <span class="o">%=</span> <span class="mi">100</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">data</span><span class="o">::</span><span class="n">digits</span> <span class="o">+</span> <span class="n">exp</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
  <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
  <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">float_writer</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="c1">// The number is given as v = digits_ * pow(10, exp_).</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">digits_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">num_digits_</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">exp_</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">size_</span><span class="p">;</span>
  <span class="n">float_specs</span> <span class="n">specs_</span><span class="p">;</span>
  <span class="n">Char</span> <span class="n">decimal_point_</span><span class="p">;</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="n">It</span> <span class="n">prettify</span><span class="p">(</span><span class="n">It</span> <span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="c1">// pow(10, full_exp - 1) &lt;= v &lt;= pow(10, full_exp).</span>
    <span class="kt">int</span> <span class="n">full_exp</span> <span class="o">=</span> <span class="n">num_digits_</span> <span class="o">+</span> <span class="n">exp_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">float_format</span><span class="o">::</span><span class="n">exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Insert a decimal point after the first digit and add an exponent.</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">digits_</span><span class="p">);</span>
      <span class="kt">int</span> <span class="n">num_zeros</span> <span class="o">=</span> <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">-</span> <span class="n">num_digits_</span><span class="p">;</span>
      <span class="kt">bool</span> <span class="n">trailing_zeros</span> <span class="o">=</span> <span class="n">num_zeros</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">specs_</span><span class="p">.</span><span class="n">trailing_zeros</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">num_digits_</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">trailing_zeros</span><span class="p">)</span>
        <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">decimal_point_</span><span class="p">;</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">digits_</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">digits_</span> <span class="o">+</span> <span class="n">num_digits_</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">trailing_zeros</span><span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">));</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">upper</span> <span class="o">?</span> <span class="sc">&#39;E&#39;</span> <span class="o">:</span> <span class="sc">&#39;e&#39;</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">write_exponent</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">full_exp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_digits_</span> <span class="o">&lt;=</span> <span class="n">full_exp</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 1234e7 -&gt; 12340000000[.0+]</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">digits_</span><span class="p">,</span> <span class="n">digits_</span> <span class="o">+</span> <span class="n">num_digits_</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">full_exp</span> <span class="o">-</span> <span class="n">num_digits_</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">trailing_zeros</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">decimal_point_</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">num_zeros</span> <span class="o">=</span> <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">-</span> <span class="n">full_exp</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_zeros</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">format</span> <span class="o">!=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">fixed</span><span class="p">)</span>
            <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
        <span class="p">}</span>
<span class="cp">#ifdef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_zeros</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
          <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;fuzz mode - avoiding excessive cpu use&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">full_exp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// 1234e-2 -&gt; 12.34[0+]</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">digits_</span><span class="p">,</span> <span class="n">digits_</span> <span class="o">+</span> <span class="n">full_exp</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">specs_</span><span class="p">.</span><span class="n">trailing_zeros</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Remove trailing zeros.</span>
        <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">num_digits_</span><span class="p">;</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">num_digits</span> <span class="o">&gt;</span> <span class="n">full_exp</span> <span class="o">&amp;&amp;</span> <span class="n">digits_</span><span class="p">[</span><span class="n">num_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
          <span class="o">--</span><span class="n">num_digits</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">num_digits</span> <span class="o">!=</span> <span class="n">full_exp</span><span class="p">)</span>
          <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">decimal_point_</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">digits_</span> <span class="o">+</span> <span class="n">full_exp</span><span class="p">,</span> <span class="n">digits_</span> <span class="o">+</span> <span class="n">num_digits</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">decimal_point_</span><span class="p">;</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">digits_</span> <span class="o">+</span> <span class="n">full_exp</span><span class="p">,</span> <span class="n">digits_</span> <span class="o">+</span> <span class="n">num_digits_</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">&gt;</span> <span class="n">num_digits_</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Add trailing zeros.</span>
        <span class="kt">int</span> <span class="n">num_zeros</span> <span class="o">=</span> <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">-</span> <span class="n">num_digits_</span><span class="p">;</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// 1234e-6 -&gt; 0.001234</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
      <span class="kt">int</span> <span class="n">num_zeros</span> <span class="o">=</span> <span class="o">-</span><span class="n">full_exp</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">&lt;</span> <span class="n">num_zeros</span><span class="p">)</span>
        <span class="n">num_zeros</span> <span class="o">=</span> <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">num_digits_</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">specs_</span><span class="p">.</span><span class="n">trailing_zeros</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">num_digits</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">digits_</span><span class="p">[</span><span class="n">num_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
          <span class="o">--</span><span class="n">num_digits</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">num_zeros</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">num_digits</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">decimal_point_</span><span class="p">;</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">));</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">digits_</span><span class="p">,</span> <span class="n">digits_</span> <span class="o">+</span> <span class="n">num_digits</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">float_writer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">digits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">num_digits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exp</span><span class="p">,</span> <span class="n">float_specs</span> <span class="n">specs</span><span class="p">,</span>
               <span class="n">Char</span> <span class="n">decimal_point</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">digits_</span><span class="p">(</span><span class="n">digits</span><span class="p">),</span> <span class="n">num_digits_</span><span class="p">(</span><span class="n">num_digits</span><span class="p">),</span> <span class="n">exp_</span><span class="p">(</span><span class="n">exp</span><span class="p">),</span> <span class="n">specs_</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span>
        <span class="n">decimal_point_</span><span class="p">(</span><span class="n">decimal_point</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">full_exp</span> <span class="o">=</span> <span class="n">num_digits</span> <span class="o">+</span> <span class="n">exp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">precision</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">specs</span><span class="p">.</span><span class="nl">precision</span> <span class="p">:</span> <span class="mi">16</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">float_format</span><span class="o">::</span><span class="n">general</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="p">(</span><span class="n">full_exp</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">full_exp</span> <span class="o">&lt;</span> <span class="n">precision</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">specs_</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">exp</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">size_</span> <span class="o">=</span> <span class="n">prettify</span><span class="p">(</span><span class="n">counting_iterator</span><span class="p">()).</span><span class="n">count</span><span class="p">();</span>
    <span class="n">size_</span> <span class="o">+=</span> <span class="n">specs</span><span class="p">.</span><span class="n">sign</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size_</span><span class="p">;</span> <span class="p">}</span>
  <span class="kt">size_t</span> <span class="n">width</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size</span><span class="p">();</span> <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">sign</span><span class="p">)</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">signs</span><span class="p">[</span><span class="n">specs_</span><span class="p">.</span><span class="n">sign</span><span class="p">]);</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">prettify</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">int</span> <span class="n">format_float</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">precision</span><span class="p">,</span> <span class="n">float_specs</span> <span class="n">specs</span><span class="p">,</span> <span class="n">buffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

<span class="c1">// Formats a floating-point number with snprintf.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">int</span> <span class="n">snprintf_float</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">precision</span><span class="p">,</span> <span class="n">float_specs</span> <span class="n">specs</span><span class="p">,</span>
                   <span class="n">buffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span> <span class="n">promote_float</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">value</span><span class="p">;</span> <span class="p">}</span>
<span class="kr">inline</span> <span class="kt">double</span> <span class="n">promote_float</span><span class="p">(</span><span class="kt">float</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">value</span><span class="p">;</span> <span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">handle_int_type_spec</span><span class="p">(</span><span class="kt">char</span> <span class="n">spec</span><span class="p">,</span> <span class="n">Handler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
  <span class="k">case</span> <span class="sc">&#39;d&#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_dec</span><span class="p">();</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;x&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="sc">&#39;X&#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_hex</span><span class="p">();</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;b&#39;</span><span class="o">:</span>
  <span class="k">case</span> <span class="sc">&#39;B&#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_bin</span><span class="p">();</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;o&#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_oct</span><span class="p">();</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_num</span><span class="p">();</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ErrorHandler</span> <span class="o">=</span> <span class="n">error_handler</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="n">float_specs</span> <span class="n">parse_float_type_spec</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="o">&amp;&amp;</span><span class="n">eh</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">result</span> <span class="o">=</span> <span class="n">float_specs</span><span class="p">();</span>
  <span class="n">result</span><span class="p">.</span><span class="n">trailing_zeros</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">alt</span><span class="p">;</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">general</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">trailing_zeros</span> <span class="o">|=</span> <span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;G&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">FMT_FALLTHROUGH</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;g&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">general</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;E&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">FMT_FALLTHROUGH</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;e&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">exp</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">trailing_zeros</span> <span class="o">|=</span> <span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;F&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">FMT_FALLTHROUGH</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;f&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">fixed</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">trailing_zeros</span> <span class="o">|=</span> <span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="cp">#if FMT_DEPRECATED_PERCENT</span>
  <span class="k">case</span> <span class="sc">&#39;%&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">fixed</span><span class="p">;</span>
    <span class="n">result</span><span class="p">.</span><span class="n">percent</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
  <span class="k">case</span> <span class="sc">&#39;A&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">upper</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">FMT_FALLTHROUGH</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;a&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">float_format</span><span class="o">::</span><span class="n">hex</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;n&#39;</span><span class="o">:</span>
    <span class="n">result</span><span class="p">.</span><span class="n">locale</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">default</span><span class="o">:</span>
    <span class="n">eh</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid type specifier&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">handle_char_specs</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">specs</span><span class="p">,</span>
                                     <span class="n">Handler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">specs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_char</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="sc">&#39;c&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_int</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">numeric</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">sign</span> <span class="o">!=</span> <span class="n">sign</span><span class="o">::</span><span class="n">none</span> <span class="o">||</span> <span class="n">specs</span><span class="o">-&gt;</span><span class="n">alt</span><span class="p">)</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid format specifier for char&quot;</span><span class="p">);</span>
  <span class="n">handler</span><span class="p">.</span><span class="n">on_char</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">handle_cstring_type_spec</span><span class="p">(</span><span class="n">Char</span> <span class="n">spec</span><span class="p">,</span> <span class="n">Handler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">spec</span> <span class="o">==</span> <span class="sc">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_string</span><span class="p">();</span>
  <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">==</span> <span class="sc">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_pointer</span><span class="p">();</span>
  <span class="k">else</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid type specifier&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">check_string_type_spec</span><span class="p">(</span><span class="n">Char</span> <span class="n">spec</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="o">&amp;&amp;</span><span class="n">eh</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span> <span class="o">!=</span> <span class="sc">&#39;s&#39;</span><span class="p">)</span>
    <span class="n">eh</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid type specifier&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">check_pointer_type_spec</span><span class="p">(</span><span class="n">Char</span> <span class="n">spec</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="o">&amp;&amp;</span><span class="n">eh</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">spec</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">spec</span> <span class="o">!=</span> <span class="sc">&#39;p&#39;</span><span class="p">)</span>
    <span class="n">eh</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid type specifier&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">int_type_checker</span> <span class="o">:</span> <span class="k">private</span> <span class="n">ErrorHandler</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="k">explicit</span> <span class="n">int_type_checker</span><span class="p">(</span><span class="n">ErrorHandler</span> <span class="n">eh</span><span class="p">)</span> <span class="o">:</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_dec</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_hex</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_bin</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_oct</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_num</span><span class="p">()</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_error</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ErrorHandler</span><span class="o">::</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid type specifier&quot;</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">char_specs_checker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ErrorHandler</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="kt">char</span> <span class="n">type_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="n">char_specs_checker</span><span class="p">(</span><span class="kt">char</span> <span class="n">type</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="n">eh</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">eh</span><span class="p">),</span> <span class="n">type_</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_int</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">handle_int_type_spec</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">int_type_checker</span><span class="o">&lt;</span><span class="n">ErrorHandler</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">));</span>
  <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_char</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">cstring_type_checker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ErrorHandler</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="k">explicit</span> <span class="n">cstring_type_checker</span><span class="p">(</span><span class="n">ErrorHandler</span> <span class="n">eh</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">ErrorHandler</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_string</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_pointer</span><span class="p">()</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">arg_map</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;::</span><span class="n">init</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">map_</span><span class="p">)</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="n">map_</span> <span class="o">=</span> <span class="k">new</span> <span class="n">entry</span><span class="p">[</span><span class="n">internal</span><span class="o">::</span><span class="n">to_unsigned</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">max_size</span><span class="p">())];</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">is_packed</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">internal</span><span class="o">::</span><span class="n">type</span> <span class="n">arg_type</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">type</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">internal</span><span class="o">::</span><span class="n">none_type</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">arg_type</span> <span class="o">==</span> <span class="n">internal</span><span class="o">::</span><span class="n">named_arg_type</span><span class="p">)</span>
        <span class="n">push_back</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">values_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">max_size</span><span class="p">();</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">type</span> <span class="o">=</span> <span class="n">args</span><span class="p">.</span><span class="n">args_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type_</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">internal</span><span class="o">::</span><span class="n">named_arg_type</span><span class="p">)</span>
      <span class="n">push_back</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">args_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value_</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">nonfinite_writer</span> <span class="p">{</span>
  <span class="n">sign_t</span> <span class="n">sign</span><span class="p">;</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
  <span class="k">static</span> <span class="k">constexpr</span> <span class="kt">size_t</span> <span class="n">str_size</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

  <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">str_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">sign</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">size_t</span> <span class="nf">width</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size</span><span class="p">();</span> <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sign</span><span class="p">)</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">signs</span><span class="p">[</span><span class="n">sign</span><span class="p">]);</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">str</span> <span class="o">+</span> <span class="n">str_size</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// This template provides operations for formatting and writing data into a</span>
<span class="c1">// character range.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Range</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">basic_writer</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">char_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Range</span><span class="o">::</span><span class="n">value_type</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">iterator</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Range</span><span class="o">::</span><span class="n">iterator</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">format_specs</span> <span class="o">=</span> <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">iterator</span> <span class="n">out_</span><span class="p">;</span> <span class="c1">// Output iterator.</span>
  <span class="n">locale_ref</span> <span class="n">locale_</span><span class="p">;</span>

  <span class="c1">// Attempts to reserve space for n extra characters in the output range.</span>
  <span class="c1">// Returns a pointer to the reserved range or a reference to out_.</span>
  <span class="k">auto</span> <span class="nf">reserve</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">reserve</span><span class="p">(</span><span class="n">out_</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">reserve</span><span class="p">(</span><span class="n">out_</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">padded_int_writer</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">size_</span><span class="p">;</span>
    <span class="n">string_view</span> <span class="n">prefix</span><span class="p">;</span>
    <span class="n">char_type</span> <span class="n">fill</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">padding</span><span class="p">;</span>
    <span class="n">F</span> <span class="n">f</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size_</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">size_t</span> <span class="nf">width</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size_</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">prefix</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">prefix</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">it</span><span class="p">);</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">fill</span><span class="p">);</span>
      <span class="n">f</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="c1">// Writes an integer in the format</span>
  <span class="c1">//   &lt;left-padding&gt;&lt;prefix&gt;&lt;numeric-padding&gt;&lt;digits&gt;&lt;right-padding&gt;</span>
  <span class="c1">// where &lt;digits&gt; are written by f(it).</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">write_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">num_digits</span><span class="p">,</span> <span class="n">string_view</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">format_specs</span> <span class="n">specs</span><span class="p">,</span> <span class="n">F</span> <span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">num_digits</span><span class="p">);</span>
    <span class="n">char_type</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">padding</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">unsiged_width</span> <span class="o">=</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">unsiged_width</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">padding</span> <span class="o">=</span> <span class="n">unsiged_width</span> <span class="o">-</span> <span class="n">size</span><span class="p">;</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">unsiged_width</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">&gt;</span> <span class="n">num_digits</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">prefix</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">+</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">precision</span><span class="p">);</span>
      <span class="n">padding</span> <span class="o">=</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">-</span> <span class="n">num_digits</span><span class="p">);</span>
      <span class="n">fill</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">none</span><span class="p">)</span>
      <span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">right</span><span class="p">;</span>
    <span class="n">write_padded</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">padded_int_writer</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">{</span><span class="n">size</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">fill</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">f</span><span class="p">});</span>
  <span class="p">}</span>

  <span class="c1">// Writes a decimal integer.</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Int</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">Int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">abs_value</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">uint32_or_64_or_128_t</span><span class="o">&lt;</span><span class="n">Int</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">negative</span> <span class="o">=</span> <span class="n">is_negative</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="c1">// Don&#39;t do -abs_value since it trips unsigned-integer-overflow sanitizer.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
      <span class="n">abs_value</span> <span class="o">=</span> <span class="o">~</span><span class="n">abs_value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">count_digits</span><span class="p">(</span><span class="n">abs_value</span><span class="p">);</span>
    <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">((</span><span class="n">negative</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">num_digits</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;-&#39;</span><span class="p">);</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">format_decimal</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// The handle_int_type_spec handler that writes an integer.</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Int</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Specs</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">int_writer</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">unsigned_type</span> <span class="o">=</span> <span class="n">uint32_or_64_or_128_t</span><span class="o">&lt;</span><span class="n">Int</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="n">basic_writer</span><span class="o">&lt;</span><span class="n">Range</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">writer</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">Specs</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">;</span>
    <span class="n">unsigned_type</span> <span class="n">abs_value</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">prefix</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="n">prefix_size</span><span class="p">;</span>

    <span class="n">string_view</span> <span class="nf">get_prefix</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">string_view</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">prefix_size</span><span class="p">);</span> <span class="p">}</span>

    <span class="n">int_writer</span><span class="p">(</span><span class="n">basic_writer</span><span class="o">&lt;</span><span class="n">Range</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="n">Int</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">Specs</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">writer</span><span class="p">(</span><span class="n">w</span><span class="p">),</span> <span class="n">specs</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="n">abs_value</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">unsigned_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span>
          <span class="n">prefix_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">is_negative</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
        <span class="o">++</span><span class="n">prefix_size</span><span class="p">;</span>
        <span class="n">abs_value</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">abs_value</span><span class="p">;</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">sign</span> <span class="o">!=</span> <span class="n">sign</span><span class="o">::</span><span class="n">none</span> <span class="o">&amp;&amp;</span> <span class="n">specs</span><span class="p">.</span><span class="n">sign</span> <span class="o">!=</span> <span class="n">sign</span><span class="o">::</span><span class="n">minus</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prefix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">sign</span> <span class="o">==</span> <span class="n">sign</span><span class="o">::</span><span class="n">plus</span> <span class="o">?</span> <span class="sc">&#39;+&#39;</span> <span class="o">:</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
        <span class="o">++</span><span class="n">prefix_size</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">dec_writer</span> <span class="p">{</span>
      <span class="n">unsigned_type</span> <span class="n">abs_value</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">num_digits</span><span class="p">;</span>

      <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">format_decimal</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="nf">on_dec</span><span class="p">()</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">count_digits</span><span class="p">(</span><span class="n">abs_value</span><span class="p">);</span>
      <span class="n">writer</span><span class="p">.</span><span class="n">write_int</span><span class="p">(</span><span class="n">num_digits</span><span class="p">,</span> <span class="n">get_prefix</span><span class="p">(),</span> <span class="n">specs</span><span class="p">,</span>
                       <span class="n">dec_writer</span><span class="p">{</span><span class="n">abs_value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">hex_writer</span> <span class="p">{</span>
      <span class="n">int_writer</span> <span class="o">&amp;</span><span class="n">self</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">num_digits</span><span class="p">;</span>

      <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">format_uint</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span> <span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">abs_value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">,</span>
                                       <span class="n">self</span><span class="p">.</span><span class="n">specs</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="sc">&#39;x&#39;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="nf">on_hex</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prefix</span><span class="p">[</span><span class="n">prefix_size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
        <span class="n">prefix</span><span class="p">[</span><span class="n">prefix_size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">count_digits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">(</span><span class="n">abs_value</span><span class="p">);</span>
      <span class="n">writer</span><span class="p">.</span><span class="n">write_int</span><span class="p">(</span><span class="n">num_digits</span><span class="p">,</span> <span class="n">get_prefix</span><span class="p">(),</span> <span class="n">specs</span><span class="p">,</span>
                       <span class="n">hex_writer</span><span class="p">{</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">template</span> <span class="o">&lt;</span><span class="kt">int</span> <span class="n">BITS</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">bin_writer</span> <span class="p">{</span>
      <span class="n">unsigned_type</span> <span class="n">abs_value</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">num_digits</span><span class="p">;</span>

      <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">format_uint</span><span class="o">&lt;</span><span class="n">BITS</span><span class="p">,</span> <span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="nf">on_bin</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">alt</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">prefix</span><span class="p">[</span><span class="n">prefix_size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
        <span class="n">prefix</span><span class="p">[</span><span class="n">prefix_size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">count_digits</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">abs_value</span><span class="p">);</span>
      <span class="n">writer</span><span class="p">.</span><span class="n">write_int</span><span class="p">(</span><span class="n">num_digits</span><span class="p">,</span> <span class="n">get_prefix</span><span class="p">(),</span> <span class="n">specs</span><span class="p">,</span>
                       <span class="n">bin_writer</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">{</span><span class="n">abs_value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="nf">on_oct</span><span class="p">()</span> <span class="p">{</span>
      <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">count_digits</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">(</span><span class="n">abs_value</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">alt</span> <span class="o">&amp;&amp;</span> <span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">&lt;=</span> <span class="n">num_digits</span> <span class="o">&amp;&amp;</span> <span class="n">abs_value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Octal prefix &#39;0&#39; is counted as a digit, so only add it if precision</span>
        <span class="c1">// is not greater than the number of digits.</span>
        <span class="n">prefix</span><span class="p">[</span><span class="n">prefix_size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">writer</span><span class="p">.</span><span class="n">write_int</span><span class="p">(</span><span class="n">num_digits</span><span class="p">,</span> <span class="n">get_prefix</span><span class="p">(),</span> <span class="n">specs</span><span class="p">,</span>
                       <span class="n">bin_writer</span><span class="o">&lt;</span><span class="mi">3</span><span class="o">&gt;</span><span class="p">{</span><span class="n">abs_value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">enum</span> <span class="p">{</span> <span class="n">sep_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>

    <span class="k">struct</span> <span class="n">num_writer</span> <span class="p">{</span>
      <span class="n">unsigned_type</span> <span class="n">abs_value</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
      <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">groups</span><span class="p">;</span>
      <span class="n">char_type</span> <span class="n">sep</span><span class="p">;</span>

      <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
        <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sep</span><span class="p">,</span> <span class="n">sep_size</span><span class="p">);</span>
        <span class="c1">// Index of a decimal digit with the least significant digit having</span>
        <span class="c1">// index 0.</span>
        <span class="kt">int</span> <span class="n">digit_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groups</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span>
        <span class="n">it</span> <span class="o">=</span> <span class="n">format_decimal</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span>
            <span class="n">it</span><span class="p">,</span> <span class="n">abs_value</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
            <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">group</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">digit_index</span><span class="p">](</span><span class="n">char_type</span> <span class="o">*&amp;</span><span class="n">buffer</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">group</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">++</span><span class="n">digit_index</span> <span class="o">%</span> <span class="o">*</span><span class="n">group</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
                  <span class="o">*</span><span class="n">group</span> <span class="o">==</span> <span class="n">max_value</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">())</span>
                <span class="k">return</span><span class="p">;</span>
              <span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">groups</span><span class="p">.</span><span class="n">cend</span><span class="p">())</span> <span class="p">{</span>
                <span class="n">digit_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="o">++</span><span class="n">group</span><span class="p">;</span>
              <span class="p">}</span>
              <span class="n">buffer</span> <span class="o">-=</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
              <span class="n">std</span><span class="o">::</span><span class="n">uninitialized_copy</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">s</span><span class="p">.</span><span class="n">data</span><span class="p">()</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
                                      <span class="n">make_checked</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">()));</span>
            <span class="p">});</span>
      <span class="p">}</span>
    <span class="p">};</span>

    <span class="kt">void</span> <span class="nf">on_num</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">groups</span> <span class="o">=</span> <span class="n">grouping</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">writer</span><span class="p">.</span><span class="n">locale_</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">groups</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">on_dec</span><span class="p">();</span>
      <span class="k">auto</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">thousands_sep</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">writer</span><span class="p">.</span><span class="n">locale_</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">on_dec</span><span class="p">();</span>
      <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">count_digits</span><span class="p">(</span><span class="n">abs_value</span><span class="p">);</span>
      <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">num_digits</span><span class="p">;</span>
      <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">group</span> <span class="o">=</span> <span class="n">groups</span><span class="p">.</span><span class="n">cbegin</span><span class="p">();</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">group</span> <span class="o">!=</span> <span class="n">groups</span><span class="p">.</span><span class="n">cend</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">num_digits</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">group</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">group</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
             <span class="o">*</span><span class="n">group</span> <span class="o">!=</span> <span class="n">max_value</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">sep_size</span><span class="p">;</span>
        <span class="n">num_digits</span> <span class="o">-=</span> <span class="o">*</span><span class="n">group</span><span class="p">;</span>
        <span class="o">++</span><span class="n">group</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">group</span> <span class="o">==</span> <span class="n">groups</span><span class="p">.</span><span class="n">cend</span><span class="p">())</span>
        <span class="n">size</span> <span class="o">+=</span> <span class="n">sep_size</span> <span class="o">*</span> <span class="p">((</span><span class="n">num_digits</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">groups</span><span class="p">.</span><span class="n">back</span><span class="p">());</span>
      <span class="n">writer</span><span class="p">.</span><span class="n">write_int</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">get_prefix</span><span class="p">(),</span> <span class="n">specs</span><span class="p">,</span>
                       <span class="n">num_writer</span><span class="p">{</span><span class="n">abs_value</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">groups</span><span class="p">,</span> <span class="n">sep</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="n">FMT_NORETURN</span> <span class="kt">void</span> <span class="nf">on_error</span><span class="p">()</span> <span class="p">{</span>
      <span class="n">FMT_THROW</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="s">&quot;invalid type specifier&quot;</span><span class="p">));</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">str_writer</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">size_</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size_</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">size_t</span> <span class="nf">width</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">count_code_points</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">size_</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s</span> <span class="o">+</span> <span class="n">size_</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">UIntPtr</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">pointer_writer</span> <span class="p">{</span>
    <span class="n">UIntPtr</span> <span class="n">value</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">num_digits</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">num_digits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">size_t</span> <span class="nf">width</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">size</span><span class="p">();</span> <span class="p">}</span>

    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
      <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;x&#39;</span><span class="p">);</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">format_uint</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">,</span> <span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">};</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">basic_writer</span><span class="p">(</span><span class="n">Range</span> <span class="n">out</span><span class="p">,</span> <span class="n">locale_ref</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">locale_ref</span><span class="p">())</span>
      <span class="o">:</span> <span class="n">out_</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">begin</span><span class="p">()),</span> <span class="n">locale_</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">iterator</span> <span class="n">out</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">out_</span><span class="p">;</span> <span class="p">}</span>

  <span class="c1">// Writes a value in the format</span>
  <span class="c1">//   &lt;left-padding&gt;&lt;value&gt;&lt;right-padding&gt;</span>
  <span class="c1">// where &lt;value&gt; is written by f(it).</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">F</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="n">write_padded</span><span class="p">(</span><span class="k">const</span> <span class="n">format_specs</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">,</span> <span class="n">F</span> <span class="o">&amp;&amp;</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// User-perceived width (in code points).</span>
    <span class="kt">unsigned</span> <span class="n">width</span> <span class="o">=</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="c1">// The number of code units.</span>
    <span class="kt">size_t</span> <span class="n">num_code_points</span> <span class="o">=</span> <span class="n">width</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">f</span><span class="p">.</span><span class="n">width</span><span class="p">()</span> <span class="o">:</span> <span class="n">size</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;=</span> <span class="n">num_code_points</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">reserve</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
    <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">(</span><span class="n">width</span> <span class="o">+</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">num_code_points</span><span class="p">));</span>
    <span class="n">char_type</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">padding</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">num_code_points</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">right</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">fill</span><span class="p">);</span>
      <span class="n">f</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">center</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">left_padding</span> <span class="o">=</span> <span class="n">padding</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">left_padding</span><span class="p">,</span> <span class="n">fill</span><span class="p">);</span>
      <span class="n">f</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">padding</span> <span class="o">-</span> <span class="n">left_padding</span><span class="p">,</span> <span class="n">fill</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">f</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
      <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">fill_n</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">padding</span><span class="p">,</span> <span class="n">fill</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>

<span class="cp">#if FMT_USE_INT128</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">int128_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">uint128_t</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">write_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
<span class="cp">#endif</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Spec</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">write_int</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">Spec</span> <span class="o">&amp;</span><span class="n">spec</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handle_int_type_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">int_writer</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Spec</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">spec</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_floating_point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">T</span> <span class="n">value</span><span class="p">,</span> <span class="n">format_specs</span> <span class="n">specs</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="n">float_specs</span> <span class="n">fspecs</span> <span class="o">=</span> <span class="n">parse_float_type_spec</span><span class="p">(</span><span class="n">specs</span><span class="p">);</span>
    <span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">sign</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">signbit</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span> <span class="c1">// value &lt; 0 is false for NaN so use signbit.</span>
      <span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span><span class="o">::</span><span class="n">minus</span><span class="p">;</span>
      <span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="n">value</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span> <span class="o">==</span> <span class="n">sign</span><span class="o">::</span><span class="n">minus</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span><span class="o">::</span><span class="n">none</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">isfinite</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">str</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">isinf</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">fspecs</span><span class="p">.</span><span class="n">upper</span> <span class="o">?</span> <span class="s">&quot;INF&quot;</span> <span class="o">:</span> <span class="s">&quot;inf&quot;</span><span class="p">)</span>
                                   <span class="o">:</span> <span class="p">(</span><span class="n">fspecs</span><span class="p">.</span><span class="n">upper</span> <span class="o">?</span> <span class="s">&quot;NAN&quot;</span> <span class="o">:</span> <span class="s">&quot;nan&quot;</span><span class="p">);</span>
      <span class="k">return</span> <span class="nf">write_padded</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">nonfinite_writer</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">{</span><span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span><span class="p">,</span> <span class="n">str</span><span class="p">});</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">none</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">right</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">numeric</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">signs</span><span class="p">[</span><span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span><span class="p">]);</span>
        <span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span><span class="o">::</span><span class="n">none</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
          <span class="o">--</span><span class="n">specs</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">specs</span><span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">right</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">memory_buffer</span> <span class="n">buffer</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fspecs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">float_format</span><span class="o">::</span><span class="n">hex</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span><span class="p">)</span>
        <span class="n">buffer</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">data</span><span class="o">::</span><span class="n">signs</span><span class="p">[</span><span class="n">fspecs</span><span class="p">.</span><span class="n">sign</span><span class="p">]);</span>
      <span class="n">snprintf_float</span><span class="p">(</span><span class="n">promote_float</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">specs</span><span class="p">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">fspecs</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
      <span class="n">write_padded</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">str_writer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">{</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()});</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kt">int</span> <span class="n">precision</span> <span class="o">=</span> <span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">specs</span><span class="p">.</span><span class="n">type</span> <span class="o">?</span> <span class="n">specs</span><span class="p">.</span><span class="nl">precision</span> <span class="p">:</span> <span class="mi">6</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fspecs</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">float_format</span><span class="o">::</span><span class="n">exp</span><span class="p">)</span>
      <span class="o">++</span><span class="n">precision</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">const_check</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">float</span><span class="o">&gt;</span><span class="p">()))</span>
      <span class="n">fspecs</span><span class="p">.</span><span class="n">binary32</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">fspecs</span><span class="p">.</span><span class="n">use_grisu</span> <span class="o">=</span> <span class="n">use_grisu</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">const_check</span><span class="p">(</span><span class="n">FMT_DEPRECATED_PERCENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fspecs</span><span class="p">.</span><span class="n">percent</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">*=</span> <span class="mi">100</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">format_float</span><span class="p">(</span><span class="n">promote_float</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">precision</span><span class="p">,</span> <span class="n">fspecs</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">const_check</span><span class="p">(</span><span class="n">FMT_DEPRECATED_PERCENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">fspecs</span><span class="p">.</span><span class="n">percent</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">buffer</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sc">&#39;%&#39;</span><span class="p">);</span>
      <span class="o">--</span><span class="n">exp</span><span class="p">;</span> <span class="c1">// Adjust decimal place position.</span>
    <span class="p">}</span>
    <span class="n">fspecs</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span><span class="p">;</span>
    <span class="n">char_type</span> <span class="n">point</span> <span class="o">=</span> <span class="n">fspecs</span><span class="p">.</span><span class="n">locale</span> <span class="o">?</span> <span class="n">decimal_point</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">locale_</span><span class="p">)</span>
                                    <span class="o">:</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;.&#39;</span><span class="p">);</span>
    <span class="n">write_padded</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">float_writer</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span>
                                                <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">size</span><span class="p">()),</span>
                                                <span class="n">exp</span><span class="p">,</span> <span class="n">fspecs</span><span class="p">,</span> <span class="n">point</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">char</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">char_type</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">Char</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">string_view</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">copy_str</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">it</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">wstring_view</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">static_assert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">char_type</span><span class="p">,</span> <span class="kt">wchar_t</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
    <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">reserve</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">it</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="n">format_specs</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write_padded</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">str_writer</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">{</span><span class="n">s</span><span class="p">,</span> <span class="n">size</span><span class="p">});</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="n">format_specs</span> <span class="o">&amp;</span><span class="n">specs</span> <span class="o">=</span> <span class="p">{})</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">precision</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">precision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">size</span> <span class="o">=</span> <span class="n">code_point_index</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">specs</span><span class="p">.</span><span class="n">precision</span><span class="p">));</span>
    <span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">specs</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">UIntPtr</span><span class="o">&gt;</span>
  <span class="kt">void</span> <span class="n">write_pointer</span><span class="p">(</span><span class="n">UIntPtr</span> <span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">format_specs</span> <span class="o">*</span><span class="n">specs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">num_digits</span> <span class="o">=</span> <span class="n">count_digits</span><span class="o">&lt;</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">pw</span> <span class="o">=</span> <span class="n">pointer_writer</span><span class="o">&lt;</span><span class="n">UIntPtr</span><span class="o">&gt;</span><span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="n">num_digits</span><span class="p">};</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">specs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">pw</span><span class="p">(</span><span class="n">reserve</span><span class="p">(</span><span class="n">to_unsigned</span><span class="p">(</span><span class="n">num_digits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">));</span>
    <span class="n">format_specs</span> <span class="n">specs_copy</span> <span class="o">=</span> <span class="o">*</span><span class="n">specs</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_copy</span><span class="p">.</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">none</span><span class="p">)</span>
      <span class="n">specs_copy</span><span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">right</span><span class="p">;</span>
    <span class="n">write_padded</span><span class="p">(</span><span class="n">specs_copy</span><span class="p">,</span> <span class="n">pw</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">using</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">basic_writer</span><span class="o">&lt;</span><span class="n">buffer_range</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="nl">is_integral</span> <span class="p">:</span> <span class="n">std</span><span class="o">::</span><span class="n">is_integral</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{};</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="k">struct</span> <span class="n">is_integral</span><span class="o">&lt;</span><span class="n">int128_t</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span> <span class="p">{};</span>
<span class="k">template</span> <span class="o">&lt;&gt;</span> <span class="k">struct</span> <span class="n">is_integral</span><span class="o">&lt;</span><span class="n">uint128_t</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">true_type</span> <span class="p">{};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Range</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ErrorHandler</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">error_handler</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">arg_formatter_base</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">char_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Range</span><span class="o">::</span><span class="n">value_type</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">iterator</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Range</span><span class="o">::</span><span class="n">iterator</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">format_specs</span> <span class="o">=</span> <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">writer_type</span> <span class="o">=</span> <span class="n">basic_writer</span><span class="o">&lt;</span><span class="n">Range</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="n">writer_type</span> <span class="n">writer_</span><span class="p">;</span>
  <span class="n">format_specs</span> <span class="o">*</span><span class="n">specs_</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">char_writer</span> <span class="p">{</span>
    <span class="n">char_type</span> <span class="n">value</span><span class="p">;</span>

    <span class="kt">size_t</span> <span class="nf">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
    <span class="kt">size_t</span> <span class="nf">width</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">It</span> <span class="o">&amp;&amp;</span><span class="n">it</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="o">*</span><span class="n">it</span><span class="o">++</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="kt">void</span> <span class="nf">write_char</span><span class="p">(</span><span class="n">char_type</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">)</span>
      <span class="n">writer_</span><span class="p">.</span><span class="n">write_padded</span><span class="p">(</span><span class="o">*</span><span class="n">specs_</span><span class="p">,</span> <span class="n">char_writer</span><span class="p">{</span><span class="n">value</span><span class="p">});</span>
    <span class="k">else</span>
      <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">write_pointer</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">writer_</span><span class="p">.</span><span class="n">write_pointer</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">to_uintptr</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">specs_</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="n">writer_type</span> <span class="o">&amp;</span><span class="n">writer</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">writer_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">FMT_DEPRECATED</span> <span class="n">format_specs</span> <span class="o">*</span><span class="n">spec</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">specs_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">format_specs</span> <span class="o">*</span><span class="n">specs</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">specs_</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">iterator</span> <span class="n">out</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="n">writer_</span><span class="p">.</span><span class="n">out</span><span class="p">();</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="kt">bool</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">string_view</span> <span class="n">sv</span><span class="p">(</span><span class="n">value</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>
    <span class="n">specs_</span> <span class="o">?</span> <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">sv</span><span class="p">,</span> <span class="o">*</span><span class="n">specs_</span><span class="p">)</span> <span class="o">:</span> <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">sv</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">write</span><span class="p">(</span><span class="k">const</span> <span class="n">char_type</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">FMT_THROW</span><span class="p">(</span><span class="n">format_error</span><span class="p">(</span><span class="s">&quot;string pointer is null&quot;</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">length</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">char_traits</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;::</span><span class="n">length</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
      <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">sv</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
      <span class="n">specs_</span> <span class="o">?</span> <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">sv</span><span class="p">,</span> <span class="o">*</span><span class="n">specs_</span><span class="p">)</span> <span class="o">:</span> <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">sv</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="n">arg_formatter_base</span><span class="p">(</span><span class="n">Range</span> <span class="n">r</span><span class="p">,</span> <span class="n">format_specs</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">writer_</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">loc</span><span class="p">),</span> <span class="n">specs_</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">iterator</span> <span class="k">operator</span><span class="p">()(</span><span class="n">monostate</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&quot;invalid argument type&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">out</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">is_integral</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="n">iterator</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">)</span>
      <span class="n">writer_</span><span class="p">.</span><span class="n">write_int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">specs_</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">out</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">iterator</span> <span class="k">operator</span><span class="p">()(</span><span class="n">char_type</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">handle_char_specs</span><span class="p">(</span>
        <span class="n">specs_</span><span class="p">,</span> <span class="n">char_spec_handler</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)));</span>
    <span class="k">return</span> <span class="nf">out</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">iterator</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">bool</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span> <span class="o">&amp;&amp;</span> <span class="n">specs_</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">)(</span><span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">out</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_floating_point</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="n">iterator</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">specs_</span> <span class="o">?</span> <span class="o">*</span><span class="nl">specs_</span> <span class="p">:</span> <span class="n">format_specs</span><span class="p">());</span>
    <span class="k">return</span> <span class="nf">out</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">struct</span> <span class="nl">char_spec_handler</span> <span class="p">:</span> <span class="n">ErrorHandler</span> <span class="p">{</span>
    <span class="n">arg_formatter_base</span> <span class="o">&amp;</span><span class="n">formatter</span><span class="p">;</span>
    <span class="n">char_type</span> <span class="n">value</span><span class="p">;</span>

    <span class="n">char_spec_handler</span><span class="p">(</span><span class="n">arg_formatter_base</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="n">char_type</span> <span class="n">val</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">formatter</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{}</span>

    <span class="kt">void</span> <span class="n">on_int</span><span class="p">()</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">formatter</span><span class="p">.</span><span class="n">specs_</span><span class="p">)</span>
        <span class="n">formatter</span><span class="p">.</span><span class="n">writer_</span><span class="p">.</span><span class="n">write_int</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">formatter</span><span class="p">.</span><span class="n">specs_</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">formatter</span><span class="p">.</span><span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="kt">void</span> <span class="n">on_char</span><span class="p">()</span> <span class="p">{</span> <span class="n">formatter</span><span class="p">.</span><span class="n">write_char</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="k">struct</span> <span class="nl">cstring_spec_handler</span> <span class="p">:</span> <span class="n">internal</span><span class="o">::</span><span class="n">error_handler</span> <span class="p">{</span>
    <span class="n">arg_formatter_base</span> <span class="o">&amp;</span><span class="n">formatter</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">char_type</span> <span class="o">*</span><span class="n">value</span><span class="p">;</span>

    <span class="n">cstring_spec_handler</span><span class="p">(</span><span class="n">arg_formatter_base</span> <span class="o">&amp;</span><span class="n">f</span><span class="p">,</span> <span class="k">const</span> <span class="n">char_type</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
        <span class="o">:</span> <span class="n">formatter</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">value</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{}</span>

    <span class="kt">void</span> <span class="n">on_string</span><span class="p">()</span> <span class="p">{</span> <span class="n">formatter</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
    <span class="kt">void</span> <span class="n">on_pointer</span><span class="p">()</span> <span class="p">{</span> <span class="n">formatter</span><span class="p">.</span><span class="n">write_pointer</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="p">};</span>

  <span class="n">iterator</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">char_type</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">specs_</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">out</span><span class="p">();</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">handle_cstring_type_spec</span><span class="p">(</span><span class="n">specs_</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
                                       <span class="n">cstring_spec_handler</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">iterator</span> <span class="nf">operator</span><span class="p">()(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">internal</span><span class="o">::</span><span class="n">check_string_type_spec</span><span class="p">(</span><span class="n">specs_</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">error_handler</span><span class="p">());</span>
      <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">specs_</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">writer_</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">iterator</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">)</span>
      <span class="n">check_pointer_type_spec</span><span class="p">(</span><span class="n">specs_</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">error_handler</span><span class="p">());</span>
    <span class="n">write_pointer</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="n">FMT_CONSTEXPR</span> <span class="kt">bool</span> <span class="n">is_name_start</span><span class="p">(</span><span class="n">Char</span> <span class="n">c</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">(</span><span class="sc">&#39;a&#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;z&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="sc">&#39;A&#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;Z&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="sc">&#39;_&#39;</span> <span class="o">==</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Parses the range [begin, end) as an unsigned integer. This function assumes</span>
<span class="c1">// that the range is non-empty and the first character is a digit.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">int</span> <span class="n">parse_nonnegative_int</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*&amp;</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
                                        <span class="n">ErrorHandler</span> <span class="o">&amp;&amp;</span><span class="n">eh</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">begin</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">begin</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kt">unsigned</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// Convert to unsigned to prevent a warning.</span>
  <span class="k">constexpr</span> <span class="kt">unsigned</span> <span class="n">max_int</span> <span class="o">=</span> <span class="n">max_value</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">();</span>
  <span class="kt">unsigned</span> <span class="n">big</span> <span class="o">=</span> <span class="n">max_int</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="c1">// Check for overflow.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">big</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">max_int</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="kt">unsigned</span><span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">begin</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">begin</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_int</span><span class="p">)</span>
    <span class="n">eh</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;number is too big&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">custom_formatter</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">char_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">::</span><span class="n">char_type</span><span class="p">;</span>

  <span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">parse_ctx_</span><span class="p">;</span>
  <span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">custom_formatter</span><span class="p">(</span><span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">parse_ctx</span><span class="p">,</span>
                            <span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">parse_ctx_</span><span class="p">(</span><span class="n">parse_ctx</span><span class="p">),</span> <span class="n">ctx_</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">bool</span> <span class="k">operator</span><span class="p">()(</span><span class="k">typename</span> <span class="n">basic_format_arg</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;::</span><span class="n">handle</span> <span class="n">h</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">h</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">parse_ctx_</span><span class="p">,</span> <span class="n">ctx_</span><span class="p">);</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kt">bool</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">false</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">is_integer</span> <span class="o">=</span>
    <span class="n">bool_constant</span><span class="o">&lt;</span><span class="n">is_integral</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
                  <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">char</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
                  <span class="o">!</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="kt">wchar_t</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">width_checker</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">FMT_CONSTEXPR</span> <span class="n">width_checker</span><span class="p">(</span><span class="n">ErrorHandler</span> <span class="o">&amp;</span><span class="n">eh</span><span class="p">)</span> <span class="o">:</span> <span class="n">handler_</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">is_integer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_negative</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="n">handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;negative width&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="o">!</span><span class="n">is_integer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;width is not integer&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">ErrorHandler</span> <span class="o">&amp;</span><span class="n">handler_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">precision_checker</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">FMT_CONSTEXPR</span> <span class="n">precision_checker</span><span class="p">(</span><span class="n">ErrorHandler</span> <span class="o">&amp;</span><span class="n">eh</span><span class="p">)</span> <span class="o">:</span> <span class="n">handler_</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">is_integer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_negative</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="n">handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;negative precision&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="o">!</span><span class="n">is_integer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;precision is not integer&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">ErrorHandler</span> <span class="o">&amp;</span><span class="n">handler_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// A format specifier handler that sets fields in basic_format_specs.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">specs_setter</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">FMT_CONSTEXPR</span> <span class="n">specs_setter</span><span class="p">(</span><span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">specs_</span><span class="p">(</span><span class="n">specs</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">specs_setter</span><span class="p">(</span><span class="k">const</span> <span class="n">specs_setter</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">specs_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">specs_</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_align</span><span class="p">(</span><span class="n">align_t</span> <span class="n">align</span><span class="p">)</span> <span class="p">{</span> <span class="n">specs_</span><span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_fill</span><span class="p">(</span><span class="n">Char</span> <span class="n">fill</span><span class="p">)</span> <span class="p">{</span> <span class="n">specs_</span><span class="p">.</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_plus</span><span class="p">()</span> <span class="p">{</span> <span class="n">specs_</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span><span class="o">::</span><span class="n">plus</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_minus</span><span class="p">()</span> <span class="p">{</span> <span class="n">specs_</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span><span class="o">::</span><span class="n">minus</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_space</span><span class="p">()</span> <span class="p">{</span> <span class="n">specs_</span><span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="n">sign</span><span class="o">::</span><span class="n">space</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_hash</span><span class="p">()</span> <span class="p">{</span> <span class="n">specs_</span><span class="p">.</span><span class="n">alt</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_zero</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">specs_</span><span class="p">.</span><span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">numeric</span><span class="p">;</span>
    <span class="n">specs_</span><span class="p">.</span><span class="n">fill</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Char</span><span class="p">(</span><span class="sc">&#39;0&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_width</span><span class="p">(</span><span class="kt">int</span> <span class="n">width</span><span class="p">)</span> <span class="p">{</span> <span class="n">specs_</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_precision</span><span class="p">(</span><span class="kt">int</span> <span class="n">precision</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">precision</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">end_precision</span><span class="p">()</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_type</span><span class="p">(</span><span class="n">Char</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">specs_</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">specs_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">numeric_specs_checker</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="n">numeric_specs_checker</span><span class="p">(</span><span class="n">ErrorHandler</span> <span class="o">&amp;</span><span class="n">eh</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">type</span> <span class="n">arg_type</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">error_handler_</span><span class="p">(</span><span class="n">eh</span><span class="p">),</span> <span class="n">arg_type_</span><span class="p">(</span><span class="n">arg_type</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">require_numeric_argument</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_arithmetic_type</span><span class="p">(</span><span class="n">arg_type_</span><span class="p">))</span>
      <span class="n">error_handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;format specifier requires numeric argument&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">check_sign</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">require_numeric_argument</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_integral_type</span><span class="p">(</span><span class="n">arg_type_</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">arg_type_</span> <span class="o">!=</span> <span class="n">int_type</span> <span class="o">&amp;&amp;</span>
        <span class="n">arg_type_</span> <span class="o">!=</span> <span class="n">long_long_type</span> <span class="o">&amp;&amp;</span> <span class="n">arg_type_</span> <span class="o">!=</span> <span class="n">internal</span><span class="o">::</span><span class="n">char_type</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">error_handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;format specifier requires signed argument&quot;</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">check_precision</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_integral_type</span><span class="p">(</span><span class="n">arg_type_</span><span class="p">)</span> <span class="o">||</span> <span class="n">arg_type_</span> <span class="o">==</span> <span class="n">internal</span><span class="o">::</span><span class="n">pointer_type</span><span class="p">)</span>
      <span class="n">error_handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;precision not allowed for this argument type&quot;</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">ErrorHandler</span> <span class="o">&amp;</span><span class="n">error_handler_</span><span class="p">;</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">type</span> <span class="n">arg_type_</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// A format specifier handler that checks if specifiers are consistent with the</span>
<span class="c1">// argument type.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">specs_checker</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Handler</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="n">specs_checker</span><span class="p">(</span><span class="k">const</span> <span class="n">Handler</span> <span class="o">&amp;</span><span class="n">handler</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">type</span> <span class="n">arg_type</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">Handler</span><span class="p">(</span><span class="n">handler</span><span class="p">),</span> <span class="n">checker_</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">arg_type</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">specs_checker</span><span class="p">(</span><span class="k">const</span> <span class="n">specs_checker</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">Handler</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">checker_</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="n">other</span><span class="p">.</span><span class="n">arg_type_</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_align</span><span class="p">(</span><span class="n">align_t</span> <span class="n">align</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">align</span> <span class="o">==</span> <span class="n">align</span><span class="o">::</span><span class="n">numeric</span><span class="p">)</span>
      <span class="n">checker_</span><span class="p">.</span><span class="n">require_numeric_argument</span><span class="p">();</span>
    <span class="n">Handler</span><span class="o">::</span><span class="n">on_align</span><span class="p">(</span><span class="n">align</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_plus</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">checker_</span><span class="p">.</span><span class="n">check_sign</span><span class="p">();</span>
    <span class="n">Handler</span><span class="o">::</span><span class="n">on_plus</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_minus</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">checker_</span><span class="p">.</span><span class="n">check_sign</span><span class="p">();</span>
    <span class="n">Handler</span><span class="o">::</span><span class="n">on_minus</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_space</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">checker_</span><span class="p">.</span><span class="n">check_sign</span><span class="p">();</span>
    <span class="n">Handler</span><span class="o">::</span><span class="n">on_space</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_hash</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">checker_</span><span class="p">.</span><span class="n">require_numeric_argument</span><span class="p">();</span>
    <span class="n">Handler</span><span class="o">::</span><span class="n">on_hash</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_zero</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">checker_</span><span class="p">.</span><span class="n">require_numeric_argument</span><span class="p">();</span>
    <span class="n">Handler</span><span class="o">::</span><span class="n">on_zero</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">end_precision</span><span class="p">()</span> <span class="p">{</span> <span class="n">checker_</span><span class="p">.</span><span class="n">check_precision</span><span class="p">();</span> <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">numeric_specs_checker</span><span class="o">&lt;</span><span class="n">Handler</span><span class="o">&gt;</span> <span class="n">checker_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">Handler</span><span class="p">,</span> <span class="k">typename</span> <span class="n">FormatArg</span><span class="p">,</span>
          <span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">int</span> <span class="n">get_dynamic_spec</span><span class="p">(</span><span class="n">FormatArg</span> <span class="n">arg</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="n">eh</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span> <span class="o">=</span> <span class="n">visit_format_arg</span><span class="p">(</span><span class="n">Handler</span><span class="o">&lt;</span><span class="n">ErrorHandler</span><span class="o">&gt;</span><span class="p">(</span><span class="n">eh</span><span class="p">),</span> <span class="n">arg</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">max_value</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">()))</span>
    <span class="n">eh</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;number is too big&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">auto_id</span> <span class="p">{};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">::</span><span class="n">format_arg</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">ctx</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;argument index out of range&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// The standard format specifier handler with checking.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ParseContext</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">specs_handler</span> <span class="o">:</span> <span class="k">public</span> <span class="n">specs_setter</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">::</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">char_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">::</span><span class="n">char_type</span><span class="p">;</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="nf">specs_handler</span><span class="p">(</span><span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">,</span>
                              <span class="n">ParseContext</span> <span class="o">&amp;</span><span class="n">parse_ctx</span><span class="p">,</span> <span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">specs_setter</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span> <span class="n">parse_context_</span><span class="p">(</span><span class="n">parse_ctx</span><span class="p">),</span>
        <span class="n">context_</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Id</span><span class="o">&gt;</span> <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_dynamic_width</span><span class="p">(</span><span class="n">Id</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">specs_</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">get_dynamic_spec</span><span class="o">&lt;</span><span class="n">width_checker</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">get_arg</span><span class="p">(</span><span class="n">arg_id</span><span class="p">),</span> <span class="n">context_</span><span class="p">.</span><span class="n">error_handler</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Id</span><span class="o">&gt;</span> <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_dynamic_precision</span><span class="p">(</span><span class="n">Id</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">=</span> <span class="n">get_dynamic_spec</span><span class="o">&lt;</span><span class="n">precision_checker</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">get_arg</span><span class="p">(</span><span class="n">arg_id</span><span class="p">),</span> <span class="n">context_</span><span class="p">.</span><span class="n">error_handler</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">on_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span> <span class="n">context_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">message</span><span class="p">);</span> <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="c1">// This is only needed for compatibility with gcc 4.4.</span>
  <span class="k">using</span> <span class="n">format_arg</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">::</span><span class="n">format_arg</span><span class="p">;</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">format_arg</span> <span class="nf">get_arg</span><span class="p">(</span><span class="n">auto_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">get_arg</span><span class="p">(</span><span class="n">context_</span><span class="p">,</span> <span class="n">parse_context_</span><span class="p">.</span><span class="n">next_arg_id</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">format_arg</span> <span class="nf">get_arg</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">parse_context_</span><span class="p">.</span><span class="n">check_arg_id</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">get_arg</span><span class="p">(</span><span class="n">context_</span><span class="p">,</span> <span class="n">arg_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">format_arg</span> <span class="nf">get_arg</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">parse_context_</span><span class="p">.</span><span class="n">check_arg_id</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">context_</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">ParseContext</span> <span class="o">&amp;</span><span class="n">parse_context_</span><span class="p">;</span>
  <span class="n">Context</span> <span class="o">&amp;</span><span class="n">context_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="k">class</span> <span class="nc">arg_id_kind</span> <span class="p">{</span> <span class="n">none</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="p">};</span>

<span class="c1">// An argument reference.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">arg_ref</span> <span class="p">{</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="n">arg_ref</span><span class="p">()</span> <span class="o">:</span> <span class="n">kind</span><span class="p">(</span><span class="n">arg_id_kind</span><span class="o">::</span><span class="n">none</span><span class="p">),</span> <span class="n">val</span><span class="p">()</span> <span class="p">{}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="k">explicit</span> <span class="n">arg_ref</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">kind</span><span class="p">(</span><span class="n">arg_id_kind</span><span class="o">::</span><span class="n">index</span><span class="p">),</span> <span class="n">val</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="k">explicit</span> <span class="n">arg_ref</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">kind</span><span class="p">(</span><span class="n">arg_id_kind</span><span class="o">::</span><span class="n">name</span><span class="p">),</span> <span class="n">val</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">arg_ref</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="kt">int</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">kind</span> <span class="o">=</span> <span class="n">arg_id_kind</span><span class="o">::</span><span class="n">index</span><span class="p">;</span>
    <span class="n">val</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">arg_id_kind</span> <span class="n">kind</span><span class="p">;</span>
  <span class="k">union</span> <span class="n">value</span> <span class="p">{</span>
    <span class="n">FMT_CONSTEXPR</span> <span class="n">value</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">index</span><span class="p">{</span><span class="n">id</span><span class="p">}</span> <span class="p">{}</span>
    <span class="n">FMT_CONSTEXPR</span> <span class="n">value</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">:</span> <span class="n">name</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="p">{}</span>

    <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>
    <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Format specifiers with width and precision resolved at formatting rather</span>
<span class="c1">// than parsing time to allow re-using the same parsed specifiers with</span>
<span class="c1">// different sets of arguments (precompilation of format strings).</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nl">dynamic_format_specs</span> <span class="p">:</span> <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="n">arg_ref</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">width_ref</span><span class="p">;</span>
  <span class="n">arg_ref</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">precision_ref</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Format spec handler that saves references to arguments representing dynamic</span>
<span class="c1">// width and precision to be resolved at formatting time.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ParseContext</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">dynamic_specs_handler</span>
    <span class="o">:</span> <span class="k">public</span> <span class="n">specs_setter</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ParseContext</span><span class="o">::</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">char_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">ParseContext</span><span class="o">::</span><span class="n">char_type</span><span class="p">;</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="nf">dynamic_specs_handler</span><span class="p">(</span><span class="n">dynamic_format_specs</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">,</span>
                                      <span class="n">ParseContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">specs_setter</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span> <span class="n">specs_</span><span class="p">(</span><span class="n">specs</span><span class="p">),</span> <span class="n">context_</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="nf">dynamic_specs_handler</span><span class="p">(</span><span class="k">const</span> <span class="n">dynamic_specs_handler</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">specs_setter</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">),</span> <span class="n">specs_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">specs_</span><span class="p">),</span>
        <span class="n">context_</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">context_</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Id</span><span class="o">&gt;</span> <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_dynamic_width</span><span class="p">(</span><span class="n">Id</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">specs_</span><span class="p">.</span><span class="n">width_ref</span> <span class="o">=</span> <span class="n">make_arg_ref</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Id</span><span class="o">&gt;</span> <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_dynamic_precision</span><span class="p">(</span><span class="n">Id</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">specs_</span><span class="p">.</span><span class="n">precision_ref</span> <span class="o">=</span> <span class="n">make_arg_ref</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">context_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">arg_ref_type</span> <span class="o">=</span> <span class="n">arg_ref</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">arg_ref_type</span> <span class="nf">make_arg_ref</span><span class="p">(</span><span class="kt">int</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">context_</span><span class="p">.</span><span class="n">check_arg_id</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">arg_ref_type</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">arg_ref_type</span> <span class="nf">make_arg_ref</span><span class="p">(</span><span class="n">auto_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">arg_ref_type</span><span class="p">(</span><span class="n">context_</span><span class="p">.</span><span class="n">next_arg_id</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="n">arg_ref_type</span> <span class="nf">make_arg_ref</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">arg_id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">context_</span><span class="p">.</span><span class="n">check_arg_id</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
    <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">(</span>
        <span class="n">context_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">context_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span> <span class="o">-</span> <span class="n">context_</span><span class="p">.</span><span class="n">begin</span><span class="p">()));</span>
    <span class="k">return</span> <span class="n">arg_ref_type</span><span class="p">(</span><span class="n">arg_id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">dynamic_format_specs</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">specs_</span><span class="p">;</span>
  <span class="n">ParseContext</span> <span class="o">&amp;</span><span class="n">context_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">IDHandler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">parse_arg_id</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
                                       <span class="n">IDHandler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  <span class="n">Char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">begin</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">();</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">parse_nonnegative_int</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">begin</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">))</span>
      <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid format string&quot;</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nf">handler</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_name_start</span><span class="p">(</span><span class="n">c</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid format string&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">it</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">is_name_start</span><span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">it</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)));</span>
  <span class="n">handler</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">to_unsigned</span><span class="p">(</span><span class="n">it</span> <span class="o">-</span> <span class="n">begin</span><span class="p">)));</span>
  <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Adapts SpecHandler to IDHandler API for dynamic width.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">SpecHandler</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">width_adapter</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">FMT_CONSTEXPR</span> <span class="n">width_adapter</span><span class="p">(</span><span class="n">SpecHandler</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">)</span> <span class="o">:</span> <span class="n">handler</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()()</span> <span class="p">{</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_dynamic_width</span><span class="p">(</span><span class="n">auto_id</span><span class="p">());</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_dynamic_width</span><span class="p">(</span><span class="n">id</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_dynamic_width</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">SpecHandler</span> <span class="o">&amp;</span><span class="n">handler</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Adapts SpecHandler to IDHandler API for dynamic precision.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">SpecHandler</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">precision_adapter</span> <span class="p">{</span>
  <span class="k">explicit</span> <span class="n">FMT_CONSTEXPR</span> <span class="n">precision_adapter</span><span class="p">(</span><span class="n">SpecHandler</span> <span class="o">&amp;</span><span class="n">h</span><span class="p">)</span> <span class="o">:</span> <span class="n">handler</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()()</span> <span class="p">{</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_dynamic_precision</span><span class="p">(</span><span class="n">auto_id</span><span class="p">());</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_dynamic_precision</span><span class="p">(</span><span class="n">id</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_dynamic_precision</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">SpecHandler</span> <span class="o">&amp;</span><span class="n">handler</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// Parses fill and alignment.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">parse_align</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
                                      <span class="n">Handler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  <span class="k">auto</span> <span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">none</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>
    <span class="o">++</span><span class="n">i</span><span class="p">;</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">begin</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="sc">&#39;&lt;&#39;</span><span class="o">:</span>
      <span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">left</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="sc">&#39;&gt;&#39;</span><span class="o">:</span>
      <span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">right</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#if FMT_NUMERIC_ALIGN</span>
    <span class="k">case</span> <span class="sc">&#39;=&#39;</span><span class="o">:</span>
      <span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">numeric</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">case</span> <span class="sc">&#39;^&#39;</span><span class="o">:</span>
      <span class="n">align</span> <span class="o">=</span> <span class="n">align</span><span class="o">::</span><span class="n">center</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">align</span> <span class="o">!=</span> <span class="n">align</span><span class="o">::</span><span class="n">none</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">begin</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid fill character &#39;{&#39;&quot;</span><span class="p">),</span> <span class="n">begin</span><span class="p">;</span>
        <span class="n">begin</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">handler</span><span class="p">.</span><span class="n">on_fill</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span>
        <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
      <span class="n">handler</span><span class="p">.</span><span class="n">on_align</span><span class="p">(</span><span class="n">align</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">parse_width</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
                                      <span class="n">Handler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="o">*</span><span class="n">begin</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">begin</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_width</span><span class="p">(</span><span class="n">parse_nonnegative_int</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">handler</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span>
      <span class="n">begin</span> <span class="o">=</span> <span class="n">parse_arg_id</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">width_adapter</span><span class="o">&lt;</span><span class="n">Handler</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">handler</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">begin</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid format string&quot;</span><span class="p">),</span> <span class="n">begin</span><span class="p">;</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">parse_precision</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
                                          <span class="n">Handler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">c</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">?</span> <span class="o">*</span><span class="nl">begin</span> <span class="p">:</span> <span class="n">Char</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">&lt;=</span> <span class="n">c</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_precision</span><span class="p">(</span><span class="n">parse_nonnegative_int</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">handler</span><span class="p">));</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">begin</span> <span class="o">=</span>
          <span class="n">parse_arg_id</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">precision_adapter</span><span class="o">&lt;</span><span class="n">Handler</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">handler</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">begin</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid format string&quot;</span><span class="p">),</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;missing precision specifier&quot;</span><span class="p">),</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">handler</span><span class="p">.</span><span class="n">end_precision</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Parses standard format specifiers and sends notifications about parsed</span>
<span class="c1">// components to handler.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">SpecHandler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">parse_format_specs</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span>
                                             <span class="n">SpecHandler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">begin</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>

  <span class="n">begin</span> <span class="o">=</span> <span class="n">parse_align</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>

  <span class="c1">// Parse sign.</span>
  <span class="k">switch</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">begin</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">case</span> <span class="sc">&#39;+&#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_plus</span><span class="p">();</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39;-&#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_minus</span><span class="p">();</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="sc">&#39; &#39;</span><span class="o">:</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_space</span><span class="p">();</span>
    <span class="o">++</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_hash</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Parse zero flag.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">==</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_zero</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">begin</span> <span class="o">=</span> <span class="n">parse_width</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>

  <span class="c1">// Parse precision.</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">==</span> <span class="sc">&#39;.&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">parse_precision</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Parse type.</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">begin</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_type</span><span class="p">(</span><span class="o">*</span><span class="n">begin</span><span class="o">++</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Return the result via the out param to workaround gcc bug 77539.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="kt">bool</span> <span class="n">IS_CONSTEXPR</span><span class="p">,</span> <span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Ptr</span> <span class="o">=</span> <span class="k">const</span> <span class="n">T</span> <span class="o">*&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">bool</span> <span class="n">find</span><span class="p">(</span><span class="n">Ptr</span> <span class="n">first</span><span class="p">,</span> <span class="n">Ptr</span> <span class="n">last</span><span class="p">,</span> <span class="n">T</span> <span class="n">value</span><span class="p">,</span> <span class="n">Ptr</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">out</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span> <span class="n">out</span> <span class="o">!=</span> <span class="n">last</span><span class="p">;</span> <span class="o">++</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">out</span> <span class="o">==</span> <span class="n">value</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;&gt;</span>
<span class="kr">inline</span> <span class="kt">bool</span> <span class="n">find</span><span class="o">&lt;</span><span class="nb">false</span><span class="p">,</span> <span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">first</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">last</span><span class="p">,</span> <span class="kt">char</span> <span class="n">value</span><span class="p">,</span>
                              <span class="k">const</span> <span class="kt">char</span> <span class="o">*&amp;</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">out</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*&gt;</span><span class="p">(</span>
      <span class="n">std</span><span class="o">::</span><span class="n">memchr</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">to_unsigned</span><span class="p">(</span><span class="n">last</span> <span class="o">-</span> <span class="n">first</span><span class="p">)));</span>
  <span class="k">return</span> <span class="n">out</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Handler</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">id_adapter</span> <span class="p">{</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()()</span> <span class="p">{</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_arg_id</span><span class="p">();</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_arg_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span> <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_arg_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Handler</span> <span class="o">&amp;</span><span class="n">handler</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="kt">bool</span> <span class="n">IS_CONSTEXPR</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Handler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">parse_format_string</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span>
                                       <span class="n">Handler</span> <span class="o">&amp;&amp;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">struct</span> <span class="n">pfs_writer</span> <span class="p">{</span>
    <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
        <span class="k">return</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">find</span><span class="o">&lt;</span><span class="n">IS_CONSTEXPR</span><span class="o">&gt;</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="sc">&#39;}&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">handler_</span><span class="p">.</span><span class="n">on_text</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
        <span class="o">++</span><span class="n">p</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">handler_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;unmatched &#39;}&#39; in format string&quot;</span><span class="p">);</span>
        <span class="n">handler_</span><span class="p">.</span><span class="n">on_text</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
        <span class="n">begin</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">Handler</span> <span class="o">&amp;</span><span class="n">handler_</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">write</span><span class="p">{</span><span class="n">handler</span><span class="p">};</span>
  <span class="k">auto</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">format_str</span><span class="p">.</span><span class="n">data</span><span class="p">();</span>
  <span class="k">auto</span> <span class="n">end</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">format_str</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">begin</span> <span class="o">!=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Doing two passes with memchr (one for &#39;{&#39; and another for &#39;}&#39;) is up to</span>
    <span class="c1">// 2.5x faster than the naive one-pass implementation on big format strings.</span>
    <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">begin</span> <span class="o">!=</span> <span class="sc">&#39;{&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">find</span><span class="o">&lt;</span><span class="n">IS_CONSTEXPR</span><span class="o">&gt;</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="sc">&#39;{&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">write</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
    <span class="n">write</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="o">++</span><span class="n">p</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;invalid format string&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">handler</span><span class="p">.</span><span class="n">on_arg_id</span><span class="p">();</span>
      <span class="n">handler</span><span class="p">.</span><span class="n">on_replacement_field</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">handler</span><span class="p">.</span><span class="n">on_text</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">p</span> <span class="o">=</span> <span class="n">parse_arg_id</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">id_adapter</span><span class="o">&lt;</span><span class="n">Handler</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">{</span><span class="n">handler</span><span class="p">});</span>
      <span class="n">Char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">p</span> <span class="o">!=</span> <span class="n">end</span> <span class="o">?</span> <span class="o">*</span><span class="nl">p</span> <span class="p">:</span> <span class="n">Char</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">handler</span><span class="p">.</span><span class="n">on_replacement_field</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;:&#39;</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_format_specs</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;unknown format specifier&quot;</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">handler</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;missing &#39;}&#39; in format string&quot;</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ParseContext</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="k">typename</span> <span class="n">ParseContext</span><span class="o">::</span><span class="n">char_type</span> <span class="o">*</span>
<span class="n">parse_format_specs</span><span class="p">(</span><span class="n">ParseContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">char_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">ParseContext</span><span class="o">::</span><span class="n">char_type</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">context</span> <span class="o">=</span> <span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">mapped_type</span> <span class="o">=</span>
      <span class="n">conditional_t</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">mapped_type_constant</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">context</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">!=</span>
                        <span class="n">internal</span><span class="o">::</span><span class="n">custom_type</span><span class="p">,</span>
                    <span class="k">decltype</span><span class="p">(</span><span class="n">arg_mapper</span><span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">declval</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">())),</span> <span class="n">T</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">auto</span> <span class="n">f</span> <span class="o">=</span> <span class="n">conditional_t</span><span class="o">&lt;</span><span class="n">has_formatter</span><span class="o">&lt;</span><span class="n">mapped_type</span><span class="p">,</span> <span class="n">context</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
                         <span class="n">formatter</span><span class="o">&lt;</span><span class="n">mapped_type</span><span class="p">,</span> <span class="n">char_type</span><span class="o">&gt;</span><span class="p">,</span>
                         <span class="n">internal</span><span class="o">::</span><span class="n">fallback_formatter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">char_type</span><span class="o">&gt;&gt;</span><span class="p">();</span>
  <span class="k">return</span> <span class="n">f</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ErrorHandler</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">format_string_checker</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">FMT_CONSTEXPR</span>
  <span class="n">format_string_checker</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">ErrorHandler</span> <span class="n">eh</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">arg_id_</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">context_</span><span class="p">(</span><span class="n">format_str</span><span class="p">,</span> <span class="n">eh</span><span class="p">),</span>
        <span class="n">parse_funcs_</span><span class="p">{</span><span class="o">&amp;</span><span class="n">parse_format_specs</span><span class="o">&lt;</span><span class="n">Args</span><span class="p">,</span> <span class="n">parse_context_type</span><span class="o">&gt;</span><span class="p">...}</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_text</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_arg_id</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">arg_id_</span> <span class="o">=</span> <span class="n">context_</span><span class="p">.</span><span class="n">next_arg_id</span><span class="p">();</span>
    <span class="n">check_arg_id</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_arg_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">arg_id_</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="n">context_</span><span class="p">.</span><span class="n">check_arg_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">check_arg_id</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_arg_id</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">on_error</span><span class="p">(</span><span class="s">&quot;compile-time checks don&#39;t support named arguments&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_replacement_field</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="p">)</span> <span class="p">{}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">on_format_specs</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">advance_to</span><span class="p">(</span><span class="n">context_</span><span class="p">,</span> <span class="n">begin</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">arg_id_</span> <span class="o">&lt;</span> <span class="n">num_args</span> <span class="o">?</span> <span class="n">parse_funcs_</span><span class="p">[</span><span class="n">arg_id_</span><span class="p">](</span><span class="n">context_</span><span class="p">)</span> <span class="o">:</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="n">on_error</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">context_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">parse_context_type</span> <span class="o">=</span> <span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">enum</span> <span class="p">{</span> <span class="n">num_args</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">Args</span><span class="p">)</span> <span class="p">};</span>

  <span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span> <span class="nf">check_arg_id</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">arg_id_</span> <span class="o">&gt;=</span> <span class="n">num_args</span><span class="p">)</span>
      <span class="n">context_</span><span class="p">.</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;argument index out of range&quot;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Format specifier parsing function.</span>
  <span class="k">using</span> <span class="n">parse_func</span> <span class="o">=</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="n">parse_context_type</span> <span class="o">&amp;</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">arg_id_</span><span class="p">;</span>
  <span class="n">parse_context_type</span> <span class="n">context_</span><span class="p">;</span>
  <span class="n">parse_func</span> <span class="n">parse_funcs_</span><span class="p">[</span><span class="n">num_args</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="nl">num_args</span> <span class="p">:</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ErrorHandler</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">bool</span> <span class="n">do_check_format_string</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">,</span>
                                          <span class="n">ErrorHandler</span> <span class="n">eh</span> <span class="o">=</span> <span class="n">ErrorHandler</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">format_string_checker</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">ErrorHandler</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span> <span class="n">checker</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">eh</span><span class="p">);</span>
  <span class="n">parse_format_string</span><span class="o">&lt;</span><span class="nb">true</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">checker</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="p">,</span> <span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
          <span class="n">enable_if_t</span><span class="o">&lt;</span><span class="p">(</span><span class="n">is_compile_string</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">),</span> <span class="kt">int</span><span class="o">&gt;&gt;</span>
<span class="kt">void</span> <span class="n">check_format_string</span><span class="p">(</span><span class="n">S</span> <span class="n">format_str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FMT_CONSTEXPR_DECL</span> <span class="kt">bool</span> <span class="n">invalid_format</span> <span class="o">=</span>
      <span class="n">internal</span><span class="o">::</span><span class="n">do_check_format_string</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">::</span><span class="n">char_type</span><span class="p">,</span>
                                       <span class="n">internal</span><span class="o">::</span><span class="n">error_handler</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span>
          <span class="n">to_string_view</span><span class="p">(</span><span class="n">format_str</span><span class="p">));</span>
  <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">invalid_format</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">Handler</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">handle_dynamic_spec</span><span class="p">(</span><span class="kt">int</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">arg_ref</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">::</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">ref</span><span class="p">,</span>
                         <span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">kind</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">arg_id_kind</span><span class="o">::</span><span class="nl">none</span><span class="p">:</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">arg_id_kind</span><span class="o">::</span><span class="nl">index</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">get_dynamic_spec</span><span class="o">&lt;</span><span class="n">Handler</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">index</span><span class="p">),</span>
                                                <span class="n">ctx</span><span class="p">.</span><span class="n">error_handler</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">arg_id_kind</span><span class="o">::</span><span class="nl">name</span><span class="p">:</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">get_dynamic_spec</span><span class="o">&lt;</span><span class="n">Handler</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">ref</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
                                                <span class="n">ctx</span><span class="p">.</span><span class="n">error_handler</span><span class="p">());</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace internal</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Range</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">basic_writer</span> <span class="n">FMT_DEPRECATED_ALIAS</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">basic_writer</span><span class="o">&lt;</span><span class="n">Range</span><span class="o">&gt;</span><span class="p">;</span>
<span class="k">using</span> <span class="n">writer</span> <span class="n">FMT_DEPRECATED_ALIAS</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">writer</span><span class="p">;</span>
<span class="k">using</span> <span class="n">wwriter</span> <span class="n">FMT_DEPRECATED_ALIAS</span> <span class="o">=</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">basic_writer</span><span class="o">&lt;</span><span class="n">buffer_range</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Range</span><span class="o">&gt;</span>
<span class="k">class</span> <span class="nc">arg_formatter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">internal</span><span class="o">::</span><span class="n">arg_formatter_base</span><span class="o">&lt;</span><span class="n">Range</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">char_type</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">Range</span><span class="o">::</span><span class="n">value_type</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">base</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">arg_formatter_base</span><span class="o">&lt;</span><span class="n">Range</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">context_type</span> <span class="o">=</span> <span class="n">basic_format_context</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">base</span><span class="o">::</span><span class="n">iterator</span><span class="p">,</span> <span class="n">char_type</span><span class="o">&gt;</span><span class="p">;</span>

  <span class="n">context_type</span> <span class="o">&amp;</span><span class="n">ctx_</span><span class="p">;</span>
  <span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">parse_ctx_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">using</span> <span class="n">range</span> <span class="o">=</span> <span class="n">Range</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">iterator</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">base</span><span class="o">::</span><span class="n">iterator</span><span class="p">;</span>
  <span class="k">using</span> <span class="n">format_specs</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">base</span><span class="o">::</span><span class="n">format_specs</span><span class="p">;</span>

  <span class="k">explicit</span> <span class="nf">arg_formatter</span><span class="p">(</span>
      <span class="n">context_type</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span>
      <span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">parse_ctx</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">,</span>
      <span class="n">format_specs</span> <span class="o">*</span><span class="n">specs</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">base</span><span class="p">(</span><span class="n">Range</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">()),</span> <span class="n">specs</span><span class="p">,</span> <span class="n">ctx</span><span class="p">.</span><span class="n">locale</span><span class="p">()),</span> <span class="n">ctx_</span><span class="p">(</span><span class="n">ctx</span><span class="p">),</span>
        <span class="n">parse_ctx_</span><span class="p">(</span><span class="n">parse_ctx</span><span class="p">)</span> <span class="p">{}</span>

  <span class="k">using</span> <span class="n">base</span><span class="o">::</span><span class="k">operator</span><span class="p">();</span>

  <span class="n">iterator</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">typename</span> <span class="n">basic_format_arg</span><span class="o">&lt;</span><span class="n">context_type</span><span class="o">&gt;::</span><span class="n">handle</span> <span class="n">handle</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">handle</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">parse_ctx_</span><span class="p">,</span> <span class="n">ctx_</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ctx_</span><span class="p">.</span><span class="n">out</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">FMT_API</span> <span class="nl">system_error</span> <span class="p">:</span> <span class="k">public</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="kt">int</span> <span class="n">err_code</span><span class="p">,</span> <span class="n">string_view</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">format_args</span> <span class="n">args</span><span class="p">);</span>

<span class="k">protected</span><span class="o">:</span>
  <span class="kt">int</span> <span class="n">error_code_</span><span class="p">;</span>

  <span class="n">system_error</span><span class="p">()</span> <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">error_code_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
  <span class="n">system_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span> <span class="n">string_view</span> <span class="n">message</span><span class="p">,</span> <span class="k">const</span> <span class="n">Args</span> <span class="o">&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">init</span><span class="p">(</span><span class="n">error_code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">make_format_args</span><span class="p">(</span><span class="n">args</span><span class="p">...));</span>
  <span class="p">}</span>
  <span class="n">system_error</span><span class="p">(</span><span class="k">const</span> <span class="n">system_error</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">system_error</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">system_error</span> <span class="o">&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">system_error</span><span class="p">(</span><span class="n">system_error</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="n">system_error</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">system_error</span> <span class="o">&amp;&amp;</span><span class="p">)</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>
  <span class="o">~</span><span class="n">system_error</span><span class="p">()</span> <span class="n">FMT_NOEXCEPT</span> <span class="n">FMT_OVERRIDE</span><span class="p">;</span>

  <span class="kt">int</span> <span class="nf">error_code</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">error_code_</span><span class="p">;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">FMT_API</span> <span class="kt">void</span> <span class="nf">format_system_error</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">out</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span>
                                 <span class="n">string_view</span> <span class="n">message</span><span class="p">)</span> <span class="n">FMT_NOEXCEPT</span><span class="p">;</span>

<span class="c1">// Reports a system error without throwing an exception.</span>
<span class="c1">// Can be used to report errors from destructors.</span>
<span class="n">FMT_API</span> <span class="kt">void</span> <span class="nf">report_system_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span>
                                 <span class="n">string_view</span> <span class="n">message</span><span class="p">)</span> <span class="n">FMT_NOEXCEPT</span><span class="p">;</span>

<span class="cp">#if FMT_USE_WINDOWS_H</span>

<span class="k">class</span> <span class="nc">windows_error</span> <span class="o">:</span> <span class="k">public</span> <span class="n">system_error</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">FMT_API</span> <span class="kt">void</span> <span class="n">init</span><span class="p">(</span><span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span> <span class="n">string_view</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">format_args</span> <span class="n">args</span><span class="p">);</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
  <span class="n">windows_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span> <span class="n">string_view</span> <span class="n">message</span><span class="p">,</span> <span class="k">const</span> <span class="n">Args</span> <span class="o">&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">init</span><span class="p">(</span><span class="n">error_code</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">make_format_args</span><span class="p">(</span><span class="n">args</span><span class="p">...));</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// Reports a Windows error without throwing an exception.</span>
<span class="c1">// Can be used to report errors from destructors.</span>
<span class="n">FMT_API</span> <span class="kt">void</span> <span class="nf">report_windows_error</span><span class="p">(</span><span class="kt">int</span> <span class="n">error_code</span><span class="p">,</span>
                                  <span class="n">string_view</span> <span class="n">message</span><span class="p">)</span> <span class="n">FMT_NOEXCEPT</span><span class="p">;</span>

<span class="cp">#endif</span>

<span class="k">class</span> <span class="nc">format_int</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="c1">// Buffer should be large enough to hold all digits (digits10 + 1),</span>
  <span class="c1">// a sign and a null character.</span>
  <span class="k">enum</span> <span class="p">{</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">numeric_limits</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="o">&gt;::</span><span class="n">digits10</span> <span class="o">+</span> <span class="mi">3</span> <span class="p">};</span>
  <span class="k">mutable</span> <span class="kt">char</span> <span class="n">buffer_</span><span class="p">[</span><span class="n">buffer_size</span><span class="p">];</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">str_</span><span class="p">;</span>

  <span class="c1">// Formats value in reverse and returns a pointer to the beginning.</span>
  <span class="kt">char</span> <span class="o">*</span><span class="nf">format_decimal</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">buffer_</span> <span class="o">+</span> <span class="p">(</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">// Parens to workaround MSVC bug.</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Integer division is slow so do it for a group of two digits instead</span>
      <span class="c1">// of for every digit. The idea comes from the talk by Alexandrescu</span>
      <span class="c1">// &quot;Three Optimization Tips for C++&quot;. See speed-test for a comparison.</span>
      <span class="k">auto</span> <span class="n">index</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">((</span><span class="n">value</span> <span class="o">%</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
      <span class="n">value</span> <span class="o">/=</span> <span class="mi">100</span><span class="p">;</span>
      <span class="o">*--</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
      <span class="o">*--</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">*--</span><span class="n">ptr</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">value</span><span class="p">);</span>
      <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">auto</span> <span class="n">index</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
    <span class="o">*--</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
    <span class="o">*--</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">data</span><span class="o">::</span><span class="n">digits</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">ptr</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">format_signed</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">abs_value</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
    <span class="kt">bool</span> <span class="n">negative</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
      <span class="n">abs_value</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">abs_value</span><span class="p">;</span>
    <span class="n">str_</span> <span class="o">=</span> <span class="n">format_decimal</span><span class="p">(</span><span class="n">abs_value</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">negative</span><span class="p">)</span>
      <span class="o">*--</span><span class="n">str_</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
  <span class="p">}</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">format_int</span><span class="p">(</span><span class="kt">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">format_signed</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">explicit</span> <span class="n">format_int</span><span class="p">(</span><span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">format_signed</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">explicit</span> <span class="n">format_int</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span> <span class="n">format_signed</span><span class="p">(</span><span class="n">value</span><span class="p">);</span> <span class="p">}</span>
  <span class="k">explicit</span> <span class="n">format_int</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">value</span><span class="p">)</span> <span class="o">:</span> <span class="n">str_</span><span class="p">(</span><span class="n">format_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{}</span>
  <span class="k">explicit</span> <span class="n">format_int</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="o">:</span> <span class="n">str_</span><span class="p">(</span><span class="n">format_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{}</span>
  <span class="k">explicit</span> <span class="n">format_int</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="o">:</span> <span class="n">str_</span><span class="p">(</span><span class="n">format_decimal</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="p">{}</span>

  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">to_unsigned</span><span class="p">(</span><span class="n">buffer_</span> <span class="o">-</span> <span class="n">str_</span> <span class="o">+</span> <span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">str_</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">c_str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">buffer_</span><span class="p">[</span><span class="n">buffer_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">str_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">str</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="n">str_</span><span class="p">,</span> <span class="n">size</span><span class="p">());</span> <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// A formatter specialization for the core types corresponding to internal::type</span>
<span class="c1">// constants.</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Char</span><span class="p">,</span>
                 <span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">type_constant</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">!=</span>
                             <span class="n">internal</span><span class="o">::</span><span class="n">custom_type</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="n">formatter</span><span class="p">()</span> <span class="o">=</span> <span class="k">default</span><span class="p">;</span>

  <span class="c1">// Parses format specifiers stopping either at the end of the range or at the</span>
  <span class="c1">// terminating &#39;}&#39;.</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ParseContext</span><span class="o">&gt;</span>
  <span class="n">FMT_CONSTEXPR</span> <span class="k">auto</span> <span class="n">parse</span><span class="p">(</span><span class="n">ParseContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">handler_type</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">dynamic_specs_handler</span><span class="o">&lt;</span><span class="n">ParseContext</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">type</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">type_constant</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">specs_checker</span><span class="o">&lt;</span><span class="n">handler_type</span><span class="o">&gt;</span> <span class="n">handler</span><span class="p">(</span><span class="n">handler_type</span><span class="p">(</span><span class="n">specs_</span><span class="p">,</span> <span class="n">ctx</span><span class="p">),</span>
                                                  <span class="n">type</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">parse_format_specs</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ctx</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">handler</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">eh</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">error_handler</span><span class="p">();</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">none_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">named_arg_type</span><span class="p">:</span>
      <span class="n">FMT_ASSERT</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span> <span class="s">&quot;invalid argument type&quot;</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">int_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">uint_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">long_long_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">ulong_long_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">int128_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">uint128_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">bool_type</span><span class="p">:</span>
      <span class="n">handle_int_type_spec</span><span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>
                           <span class="n">internal</span><span class="o">::</span><span class="n">int_type_checker</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">eh</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">char_type</span><span class="p">:</span>
      <span class="n">handle_char_specs</span><span class="p">(</span>
          <span class="o">&amp;</span><span class="n">specs_</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">char_specs_checker</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">eh</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">float_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">double_type</span><span class="p">:</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">long_double_type</span><span class="p">:</span>
      <span class="n">internal</span><span class="o">::</span><span class="n">parse_float_type_spec</span><span class="p">(</span><span class="n">specs_</span><span class="p">,</span> <span class="n">eh</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">cstring_type</span><span class="p">:</span>
      <span class="n">internal</span><span class="o">::</span><span class="n">handle_cstring_type_spec</span><span class="p">(</span>
          <span class="n">specs_</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">internal</span><span class="o">::</span><span class="n">cstring_type_checker</span><span class="o">&lt;</span><span class="k">decltype</span><span class="p">(</span><span class="n">eh</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">eh</span><span class="p">));</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">string_type</span><span class="p">:</span>
      <span class="n">internal</span><span class="o">::</span><span class="n">check_string_type_spec</span><span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">eh</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">pointer_type</span><span class="p">:</span>
      <span class="n">internal</span><span class="o">::</span><span class="n">check_pointer_type_spec</span><span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">eh</span><span class="p">);</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">internal</span><span class="o">::</span><span class="nl">custom_type</span><span class="p">:</span>
      <span class="c1">// Custom format specifiers should be checked in parse functions of</span>
      <span class="c1">// formatter specializations.</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">FormatContext</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">format</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">FormatContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">handle_dynamic_spec</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">width_checker</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">specs_</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">specs_</span><span class="p">.</span><span class="n">width_ref</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">handle_dynamic_spec</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">precision_checker</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">specs_</span><span class="p">.</span><span class="n">precision_ref</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
    <span class="k">using</span> <span class="n">range_type</span> <span class="o">=</span>
        <span class="n">internal</span><span class="o">::</span><span class="n">output_range</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">FormatContext</span><span class="o">::</span><span class="n">iterator</span><span class="p">,</span>
                               <span class="k">typename</span> <span class="n">FormatContext</span><span class="o">::</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">visit_format_arg</span><span class="p">(</span><span class="n">arg_formatter</span><span class="o">&lt;</span><span class="n">range_type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">specs_</span><span class="p">),</span>
                            <span class="n">internal</span><span class="o">::</span><span class="n">make_arg</span><span class="o">&lt;</span><span class="n">FormatContext</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">dynamic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">specs_</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FMT_FORMAT_AS(Type, Base)                                              \</span>
<span class="cp">  template &lt;typename Char&gt;                                                     \</span>
<span class="cp">  struct formatter&lt;Type, Char&gt; : formatter&lt;Base, Char&gt; {                       \</span>
<span class="cp">    template &lt;typename FormatContext&gt;                                          \</span>
<span class="cp">    auto format(const Type &amp;val, FormatContext &amp;ctx) -&gt; decltype(ctx.out()) {  \</span>
<span class="cp">      return formatter&lt;Base, Char&gt;::format(val, ctx);                          \</span>
<span class="cp">    }                                                                          \</span>
<span class="cp">  }</span>

<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="kt">signed</span> <span class="kt">char</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="kt">short</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="kt">long</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="n">Char</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">nullptr_t</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="n">FMT_FORMAT_AS</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">std_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">);</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">FormatContext</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">format</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">FormatContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;::</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">N</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">[</span><span class="n">N</span><span class="p">],</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="o">:</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">FormatContext</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">format</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="n">FormatContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;::</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// A formatter for types known only at run time such as variant alternatives.</span>
<span class="c1">//</span>
<span class="c1">// Usage:</span>
<span class="c1">//   using variant = std::variant&lt;int, std::string&gt;;</span>
<span class="c1">//   template &lt;&gt;</span>
<span class="c1">//   struct formatter&lt;variant&gt;: dynamic_formatter&lt;&gt; {</span>
<span class="c1">//     void format(buffer &amp;buf, const variant &amp;v, context &amp;ctx) {</span>
<span class="c1">//       visit([&amp;](const auto &amp;val) { format(buf, val, ctx); }, v);</span>
<span class="c1">//     }</span>
<span class="c1">//   };</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span> <span class="o">=</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">dynamic_formatter</span> <span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
  <span class="k">struct</span> <span class="nl">null_handler</span> <span class="p">:</span> <span class="n">internal</span><span class="o">::</span><span class="n">error_handler</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="n">on_align</span><span class="p">(</span><span class="n">align_t</span><span class="p">)</span> <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">on_plus</span><span class="p">()</span> <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">on_minus</span><span class="p">()</span> <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">on_space</span><span class="p">()</span> <span class="p">{}</span>
    <span class="kt">void</span> <span class="n">on_hash</span><span class="p">()</span> <span class="p">{}</span>
  <span class="p">};</span>

<span class="k">public</span><span class="o">:</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ParseContext</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">parse</span><span class="p">(</span><span class="n">ParseContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">format_str_</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="c1">// Checks are deferred to formatting time when the argument type is known.</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">dynamic_specs_handler</span><span class="o">&lt;</span><span class="n">ParseContext</span><span class="o">&gt;</span> <span class="n">handler</span><span class="p">(</span><span class="n">specs_</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
    <span class="k">return</span> <span class="nf">parse_format_specs</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">ctx</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">handler</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">FormatContext</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">format</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="n">FormatContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">handle_specs</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">specs_checker</span><span class="o">&lt;</span><span class="n">null_handler</span><span class="o">&gt;</span> <span class="n">checker</span><span class="p">(</span>
        <span class="n">null_handler</span><span class="p">(),</span>
        <span class="n">internal</span><span class="o">::</span><span class="n">mapped_type_constant</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">FormatContext</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">);</span>
    <span class="n">checker</span><span class="p">.</span><span class="n">on_align</span><span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">align</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">sign</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">sign</span><span class="o">::</span><span class="nl">none</span><span class="p">:</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">sign</span><span class="o">::</span><span class="nl">plus</span><span class="p">:</span>
      <span class="n">checker</span><span class="p">.</span><span class="n">on_plus</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">sign</span><span class="o">::</span><span class="nl">minus</span><span class="p">:</span>
      <span class="n">checker</span><span class="p">.</span><span class="n">on_minus</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">sign</span><span class="o">::</span><span class="nl">space</span><span class="p">:</span>
      <span class="n">checker</span><span class="p">.</span><span class="n">on_space</span><span class="p">();</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">alt</span><span class="p">)</span>
      <span class="n">checker</span><span class="p">.</span><span class="n">on_hash</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">specs_</span><span class="p">.</span><span class="n">precision</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">checker</span><span class="p">.</span><span class="n">end_precision</span><span class="p">();</span>
    <span class="k">using</span> <span class="n">range</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">output_range</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">FormatContext</span><span class="o">::</span><span class="n">iterator</span><span class="p">,</span>
                                         <span class="k">typename</span> <span class="n">FormatContext</span><span class="o">::</span><span class="n">char_type</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="n">visit_format_arg</span><span class="p">(</span><span class="n">arg_formatter</span><span class="o">&lt;</span><span class="n">range</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">specs_</span><span class="p">),</span>
                     <span class="n">internal</span><span class="o">::</span><span class="n">make_arg</span><span class="o">&lt;</span><span class="n">FormatContext</span><span class="o">&gt;</span><span class="p">(</span><span class="n">val</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">();</span>
  <span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span> <span class="kt">void</span> <span class="n">handle_specs</span><span class="p">(</span><span class="n">Context</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">handle_dynamic_spec</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">width_checker</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">specs_</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">specs_</span><span class="p">.</span><span class="n">width_ref</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">handle_dynamic_spec</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">precision_checker</span><span class="o">&gt;</span><span class="p">(</span>
        <span class="n">specs_</span><span class="p">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">specs_</span><span class="p">.</span><span class="n">precision_ref</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">internal</span><span class="o">::</span><span class="n">dynamic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">specs_</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">format_str_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Range</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="k">typename</span> <span class="n">basic_format_context</span><span class="o">&lt;</span><span class="n">Range</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;::</span><span class="n">format_arg</span>
<span class="n">basic_format_context</span><span class="o">&lt;</span><span class="n">Range</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;::</span><span class="n">arg</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">char_type</span><span class="o">&gt;</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">map_</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">args_</span><span class="p">);</span>
  <span class="n">format_arg</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">map_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">type</span><span class="p">()</span> <span class="o">==</span> <span class="n">internal</span><span class="o">::</span><span class="n">none_type</span><span class="p">)</span>
    <span class="k">this</span><span class="o">-&gt;</span><span class="n">on_error</span><span class="p">(</span><span class="s">&quot;argument not found&quot;</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="kt">void</span>
<span class="n">advance_to</span><span class="p">(</span><span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">ErrorHandler</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ctx</span><span class="p">.</span><span class="n">advance_to</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="o">&amp;*</span><span class="n">ctx</span><span class="p">.</span><span class="n">begin</span><span class="p">()));</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ArgFormatter</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="nl">format_handler</span> <span class="p">:</span> <span class="n">internal</span><span class="o">::</span><span class="n">error_handler</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">range</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">ArgFormatter</span><span class="o">::</span><span class="n">range</span><span class="p">;</span>

  <span class="n">format_handler</span><span class="p">(</span><span class="n">range</span> <span class="n">r</span><span class="p">,</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">str</span><span class="p">,</span>
                 <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="n">format_args</span><span class="p">,</span>
                 <span class="n">internal</span><span class="o">::</span><span class="n">locale_ref</span> <span class="n">loc</span><span class="p">)</span>
      <span class="o">:</span> <span class="n">parse_context</span><span class="p">(</span><span class="n">str</span><span class="p">),</span> <span class="n">context</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">format_args</span><span class="p">,</span> <span class="n">loc</span><span class="p">)</span> <span class="p">{}</span>

  <span class="kt">void</span> <span class="n">on_text</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">to_unsigned</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">out</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">out</span><span class="p">();</span>
    <span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">it</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">reserve</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="n">it</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">copy_n</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">it</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">advance_to</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">get_arg</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">get_arg</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">on_arg_id</span><span class="p">()</span> <span class="p">{</span> <span class="n">get_arg</span><span class="p">(</span><span class="n">parse_context</span><span class="p">.</span><span class="n">next_arg_id</span><span class="p">());</span> <span class="p">}</span>
  <span class="kt">void</span> <span class="n">on_arg_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">parse_context</span><span class="p">.</span><span class="n">check_arg_id</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
    <span class="n">get_arg</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="kt">void</span> <span class="n">on_arg_id</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">arg</span><span class="p">(</span><span class="n">id</span><span class="p">);</span> <span class="p">}</span>

  <span class="kt">void</span> <span class="n">on_replacement_field</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">advance_to</span><span class="p">(</span><span class="n">parse_context</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">advance_to</span><span class="p">(</span>
        <span class="n">visit_format_arg</span><span class="p">(</span><span class="n">ArgFormatter</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parse_context</span><span class="p">),</span> <span class="n">arg</span><span class="p">));</span>
  <span class="p">}</span>

  <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">on_format_specs</span><span class="p">(</span><span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">begin</span><span class="p">,</span> <span class="k">const</span> <span class="n">Char</span> <span class="o">*</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">advance_to</span><span class="p">(</span><span class="n">parse_context</span><span class="p">,</span> <span class="n">begin</span><span class="p">);</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">custom_formatter</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="n">f</span><span class="p">(</span><span class="n">parse_context</span><span class="p">,</span> <span class="n">context</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">visit_format_arg</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">parse_context</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
    <span class="n">basic_format_specs</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">specs</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">internal</span><span class="o">::</span><span class="n">specs_handler</span><span class="p">;</span>
    <span class="k">using</span> <span class="n">parse_context_t</span> <span class="o">=</span> <span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="n">internal</span><span class="o">::</span><span class="n">specs_checker</span><span class="o">&lt;</span><span class="n">specs_handler</span><span class="o">&lt;</span><span class="n">parse_context_t</span><span class="p">,</span> <span class="n">Context</span><span class="o">&gt;&gt;</span> <span class="n">handler</span><span class="p">(</span>
        <span class="n">specs_handler</span><span class="o">&lt;</span><span class="n">parse_context_t</span><span class="p">,</span> <span class="n">Context</span><span class="o">&gt;</span><span class="p">(</span><span class="n">specs</span><span class="p">,</span> <span class="n">parse_context</span><span class="p">,</span> <span class="n">context</span><span class="p">),</span>
        <span class="n">arg</span><span class="p">.</span><span class="n">type</span><span class="p">());</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">parse_format_specs</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">handler</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">begin</span> <span class="o">==</span> <span class="n">end</span> <span class="o">||</span> <span class="o">*</span><span class="n">begin</span> <span class="o">!=</span> <span class="sc">&#39;}&#39;</span><span class="p">)</span>
      <span class="n">on_error</span><span class="p">(</span><span class="s">&quot;missing &#39;}&#39; in format string&quot;</span><span class="p">);</span>
    <span class="n">advance_to</span><span class="p">(</span><span class="n">parse_context</span><span class="p">,</span> <span class="n">begin</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">advance_to</span><span class="p">(</span>
        <span class="n">visit_format_arg</span><span class="p">(</span><span class="n">ArgFormatter</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parse_context</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">specs</span><span class="p">),</span> <span class="n">arg</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">begin</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">basic_format_parse_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">parse_context</span><span class="p">;</span>
  <span class="n">Context</span> <span class="n">context</span><span class="p">;</span>
  <span class="n">basic_format_arg</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="n">arg</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">ArgFormatter</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Context</span><span class="o">&gt;</span>
<span class="k">typename</span> <span class="n">Context</span><span class="o">::</span><span class="n">iterator</span>
<span class="n">vformat_to</span><span class="p">(</span><span class="k">typename</span> <span class="n">ArgFormatter</span><span class="o">::</span><span class="n">range</span> <span class="n">out</span><span class="p">,</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span>
           <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">Context</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">,</span>
           <span class="n">internal</span><span class="o">::</span><span class="n">locale_ref</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">locale_ref</span><span class="p">())</span> <span class="p">{</span>
  <span class="n">format_handler</span><span class="o">&lt;</span><span class="n">ArgFormatter</span><span class="p">,</span> <span class="n">Char</span><span class="p">,</span> <span class="n">Context</span><span class="o">&gt;</span> <span class="n">h</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">loc</span><span class="p">);</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">parse_format_string</span><span class="o">&lt;</span><span class="nb">false</span><span class="o">&gt;</span><span class="p">(</span><span class="n">format_str</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">h</span><span class="p">.</span><span class="n">context</span><span class="p">.</span><span class="n">out</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Casts ``p`` to ``const void*`` for pointer formatting.</span>
<span class="c1">// Example:</span>
<span class="c1">//   auto s = format(&quot;{}&quot;, ptr(p));</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">p</span><span class="p">;</span> <span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">p</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="nl">arg_join</span> <span class="p">:</span> <span class="n">internal</span><span class="o">::</span><span class="n">view</span> <span class="p">{</span>
  <span class="n">It</span> <span class="n">begin</span><span class="p">;</span>
  <span class="n">It</span> <span class="n">end</span><span class="p">;</span>
  <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">sep</span><span class="p">;</span>

  <span class="n">arg_join</span><span class="p">(</span><span class="n">It</span> <span class="n">b</span><span class="p">,</span> <span class="n">It</span> <span class="n">e</span><span class="p">,</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">:</span> <span class="n">begin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">end</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">sep</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="p">{}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="k">struct</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="n">arg_join</span><span class="o">&lt;</span><span class="n">It</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span>
    <span class="o">:</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">It</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">FormatContext</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">format</span><span class="p">(</span><span class="k">const</span> <span class="n">arg_join</span><span class="o">&lt;</span><span class="n">It</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">FormatContext</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="p">)</span>
      <span class="o">-&gt;</span> <span class="k">decltype</span><span class="p">(</span><span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">using</span> <span class="n">base</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">std</span><span class="o">::</span><span class="n">iterator_traits</span><span class="o">&lt;</span><span class="n">It</span><span class="o">&gt;::</span><span class="n">value_type</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">begin</span><span class="p">;</span>
    <span class="k">auto</span> <span class="n">out</span> <span class="o">=</span> <span class="n">ctx</span><span class="p">.</span><span class="n">out</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">base</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="o">++</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
      <span class="k">while</span> <span class="p">(</span><span class="n">it</span> <span class="o">!=</span> <span class="n">value</span><span class="p">.</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">copy</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">sep</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">value</span><span class="p">.</span><span class="n">sep</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">out</span><span class="p">);</span>
        <span class="n">ctx</span><span class="p">.</span><span class="n">advance_to</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">base</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">it</span><span class="o">++</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">out</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span>
<span class="n">arg_join</span><span class="o">&lt;</span><span class="n">It</span><span class="p">,</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">join</span><span class="p">(</span><span class="n">It</span> <span class="n">begin</span><span class="p">,</span> <span class="n">It</span> <span class="n">end</span><span class="p">,</span> <span class="n">string_view</span> <span class="n">sep</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">sep</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">It</span><span class="o">&gt;</span>
<span class="n">arg_join</span><span class="o">&lt;</span><span class="n">It</span><span class="p">,</span> <span class="kt">wchar_t</span><span class="o">&gt;</span> <span class="n">join</span><span class="p">(</span><span class="n">It</span> <span class="n">begin</span><span class="p">,</span> <span class="n">It</span> <span class="n">end</span><span class="p">,</span> <span class="n">wstring_view</span> <span class="n">sep</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">sep</span><span class="p">};</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Range</span><span class="o">&gt;</span>
<span class="n">arg_join</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">iterator_t</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Range</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">char</span><span class="o">&gt;</span> <span class="n">join</span><span class="p">(</span><span class="k">const</span> <span class="n">Range</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">,</span>
                                                       <span class="n">string_view</span> <span class="n">sep</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">range</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">range</span><span class="p">),</span> <span class="n">sep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Range</span><span class="o">&gt;</span>
<span class="n">arg_join</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">iterator_t</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">Range</span><span class="o">&gt;</span><span class="p">,</span> <span class="kt">wchar_t</span><span class="o">&gt;</span> <span class="n">join</span><span class="p">(</span><span class="k">const</span> <span class="n">Range</span> <span class="o">&amp;</span><span class="n">range</span><span class="p">,</span>
                                                          <span class="n">wstring_view</span> <span class="n">sep</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">join</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">begin</span><span class="p">(</span><span class="n">range</span><span class="p">),</span> <span class="n">std</span><span class="o">::</span><span class="n">end</span><span class="p">(</span><span class="n">range</span><span class="p">),</span> <span class="n">sep</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_string</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">format</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">wstring</span> <span class="n">to_wstring</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">format</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;{}&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">SIZE</span><span class="o">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">to_string</span><span class="p">(</span><span class="k">const</span> <span class="n">basic_memory_buffer</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">SIZE</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">buf</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="k">typename</span> <span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;::</span><span class="n">iterator</span>
<span class="n">internal</span><span class="o">::</span><span class="n">vformat_to</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span>
                     <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span>
                     <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;&gt;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">range</span> <span class="o">=</span> <span class="n">buffer_range</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">vformat_to</span><span class="o">&lt;</span><span class="n">arg_formatter</span><span class="o">&lt;</span><span class="n">range</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">to_string_view</span><span class="p">(</span><span class="n">format_str</span><span class="p">),</span>
                                          <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span> <span class="o">=</span> <span class="n">char_t</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="p">,</span>
          <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">is_string</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="k">typename</span> <span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;::</span><span class="n">iterator</span>
<span class="n">vformat_to</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">buffer</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">S</span> <span class="o">&amp;</span><span class="n">format_str</span><span class="p">,</span>
           <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;&gt;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">vformat_to</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">to_string_view</span><span class="p">(</span><span class="n">format_str</span><span class="p">),</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">SIZE</span> <span class="o">=</span> <span class="n">inline_buffer_size</span><span class="p">,</span>
          <span class="k">typename</span> <span class="n">Char</span> <span class="o">=</span> <span class="n">enable_if_t</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">is_string</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="n">char_t</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;&gt;&gt;</span>
<span class="kr">inline</span> <span class="k">typename</span> <span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;::</span><span class="n">iterator</span>
<span class="n">format_to</span><span class="p">(</span><span class="n">basic_memory_buffer</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">SIZE</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="n">S</span> <span class="o">&amp;</span><span class="n">format_str</span><span class="p">,</span>
          <span class="n">Args</span> <span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">check_format_string</span><span class="o">&lt;</span><span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span><span class="n">format_str</span><span class="p">);</span>
  <span class="k">using</span> <span class="n">context</span> <span class="o">=</span> <span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">internal</span><span class="o">::</span><span class="n">vformat_to</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">to_string_view</span><span class="p">(</span><span class="n">format_str</span><span class="p">),</span>
                              <span class="p">{</span><span class="n">make_format_args</span><span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">...)});</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span> <span class="o">=</span> <span class="kt">char</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">format_context_t</span> <span class="o">=</span> <span class="n">basic_format_context</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span> <span class="o">=</span> <span class="kt">char</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">format_args_t</span> <span class="o">=</span> <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">format_context_t</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="p">,</span>
          <span class="n">FMT_ENABLE_IF</span><span class="p">(</span>
              <span class="n">internal</span><span class="o">::</span><span class="n">is_output_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
              <span class="o">!</span><span class="n">internal</span><span class="o">::</span><span class="n">is_contiguous_back_insert_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">OutputIt</span> <span class="n">vformat_to</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="n">S</span> <span class="o">&amp;</span><span class="n">format_str</span><span class="p">,</span>
                           <span class="n">format_args_t</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">char_t</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;&gt;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">using</span> <span class="n">range</span> <span class="o">=</span> <span class="n">internal</span><span class="o">::</span><span class="n">output_range</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">char_t</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;&gt;</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">vformat_to</span><span class="o">&lt;</span><span class="n">arg_formatter</span><span class="o">&lt;</span><span class="n">range</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">range</span><span class="p">(</span><span class="n">out</span><span class="p">),</span>
                                          <span class="n">to_string_view</span><span class="p">(</span><span class="n">format_str</span><span class="p">),</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="p">,</span>
          <span class="n">FMT_ENABLE_IF</span><span class="p">(</span>
              <span class="n">internal</span><span class="o">::</span><span class="n">is_output_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
              <span class="o">!</span><span class="n">internal</span><span class="o">::</span><span class="n">is_contiguous_back_insert_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&amp;&amp;</span>
              <span class="n">internal</span><span class="o">::</span><span class="n">is_string</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">OutputIt</span> <span class="n">format_to</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">out</span><span class="p">,</span> <span class="k">const</span> <span class="n">S</span> <span class="o">&amp;</span><span class="n">format_str</span><span class="p">,</span> <span class="n">Args</span> <span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">check_format_string</span><span class="o">&lt;</span><span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span><span class="n">format_str</span><span class="p">);</span>
  <span class="k">using</span> <span class="n">context</span> <span class="o">=</span> <span class="n">format_context_t</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">char_t</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;&gt;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nf">vformat_to</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">to_string_view</span><span class="p">(</span><span class="n">format_str</span><span class="p">),</span>
                    <span class="p">{</span><span class="n">make_format_args</span><span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">...)});</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">format_to_n_result</span> <span class="p">{</span>
  <span class="n">OutputIt</span> <span class="n">out</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">OutputIt</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">format_to_n_context</span> <span class="o">=</span>
    <span class="n">format_context_t</span><span class="o">&lt;</span><span class="n">internal</span><span class="o">::</span><span class="n">truncating_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span> <span class="o">=</span> <span class="k">typename</span> <span class="n">OutputIt</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;</span>
<span class="k">using</span> <span class="n">format_to_n_args</span> <span class="o">=</span> <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">format_to_n_context</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;&gt;</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">format_arg_store</span><span class="o">&lt;</span><span class="n">format_to_n_context</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span>
<span class="n">make_format_to_n_args</span><span class="p">(</span><span class="k">const</span> <span class="n">Args</span> <span class="o">&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">format_arg_store</span><span class="o">&lt;</span><span class="n">format_to_n_context</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span>
      <span class="n">args</span><span class="p">...);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="p">,</span>
          <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">is_output_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">format_to_n_result</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span>
<span class="n">vformat_to_n</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">out</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span>
             <span class="n">format_to_n_args</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">auto</span> <span class="n">it</span> <span class="o">=</span> <span class="n">vformat_to</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">truncating_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span>
                       <span class="n">format_str</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">{</span><span class="n">it</span><span class="p">.</span><span class="n">base</span><span class="p">(),</span> <span class="n">it</span><span class="p">.</span><span class="n">count</span><span class="p">()};</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">OutputIt</span><span class="p">,</span> <span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="p">,</span>
          <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">is_string</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">value</span>
                            <span class="o">&amp;&amp;</span><span class="n">internal</span><span class="o">::</span><span class="n">is_output_iterator</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">format_to_n_result</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="o">&gt;</span> <span class="n">format_to_n</span><span class="p">(</span><span class="n">OutputIt</span> <span class="n">out</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">,</span>
                                                <span class="k">const</span> <span class="n">S</span> <span class="o">&amp;</span><span class="n">format_str</span><span class="p">,</span>
                                                <span class="k">const</span> <span class="n">Args</span> <span class="o">&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">check_format_string</span><span class="o">&lt;</span><span class="n">Args</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span><span class="n">format_str</span><span class="p">);</span>
  <span class="k">using</span> <span class="n">context</span> <span class="o">=</span> <span class="n">format_to_n_context</span><span class="o">&lt;</span><span class="n">OutputIt</span><span class="p">,</span> <span class="n">char_t</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;&gt;</span><span class="p">;</span>
  <span class="k">return</span> <span class="nf">vformat_to_n</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">to_string_view</span><span class="p">(</span><span class="n">format_str</span><span class="p">),</span>
                      <span class="p">{</span><span class="n">make_format_args</span><span class="o">&lt;</span><span class="n">context</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">...)});</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span>
<span class="n">internal</span><span class="o">::</span><span class="n">vformat</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span>
                  <span class="n">basic_format_args</span><span class="o">&lt;</span><span class="n">buffer_context</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;&gt;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">basic_memory_buffer</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">buffer</span><span class="p">;</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">vformat_to</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
  <span class="k">return</span> <span class="nf">to_string</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
<span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">formatted_size</span><span class="p">(</span><span class="n">string_view</span> <span class="n">format_str</span><span class="p">,</span>
                                  <span class="k">const</span> <span class="n">Args</span> <span class="o">&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">format_to</span><span class="p">(</span><span class="n">internal</span><span class="o">::</span><span class="n">counting_iterator</span><span class="p">(),</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">args</span><span class="p">...).</span><span class="n">count</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="kt">wchar_t</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">vprint</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span>
            <span class="n">wformat_args</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">wmemory_buffer</span> <span class="n">buffer</span><span class="p">;</span>
  <span class="n">internal</span><span class="o">::</span><span class="n">vformat_to</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
  <span class="n">buffer</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="sa">L</span><span class="sc">&#39;\0&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">fputws</span><span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">f</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">FMT_THROW</span><span class="p">(</span><span class="n">system_error</span><span class="p">(</span><span class="n">errno</span><span class="p">,</span> <span class="s">&quot;cannot write to file&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="n">FMT_ENABLE_IF</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">is_same</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="kt">wchar_t</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">)</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">vprint</span><span class="p">(</span><span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">wformat_args</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">vprint</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="n">format_str</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if FMT_USE_USER_DEFINED_LITERALS</span>
<span class="k">namespace</span> <span class="n">internal</span> <span class="p">{</span>

<span class="cp">#if FMT_USE_UDL_TEMPLATE</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="n">Char</span><span class="p">...</span> <span class="n">CHARS</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">udl_formatter</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Args</span> <span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="n">FMT_CONSTEXPR_DECL</span> <span class="n">Char</span> <span class="n">s</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">CHARS</span><span class="p">...,</span> <span class="sc">&#39;\0&#39;</span><span class="p">};</span>
    <span class="n">FMT_CONSTEXPR_DECL</span> <span class="kt">bool</span> <span class="n">invalid_format</span> <span class="o">=</span>
        <span class="n">do_check_format_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">error_handler</span><span class="p">,</span> <span class="n">remove_cvref_t</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="p">...</span><span class="o">&gt;</span><span class="p">(</span>
            <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">...(</span><span class="n">CHARS</span><span class="p">)));</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">invalid_format</span><span class="p">;</span>
    <span class="k">return</span> <span class="nf">format</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">)...);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">udl_formatter</span> <span class="p">{</span>
  <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">str</span><span class="p">;</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span><span class="p">...</span> <span class="n">Args</span><span class="o">&gt;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">basic_string</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Args</span> <span class="o">&amp;&amp;</span><span class="p">...</span> <span class="n">args</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">format</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">Args</span><span class="o">&gt;</span><span class="p">(</span><span class="n">args</span><span class="p">)...);</span>
  <span class="p">}</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="c1">// FMT_USE_UDL_TEMPLATE</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">struct</span> <span class="n">udl_arg</span> <span class="p">{</span>
  <span class="n">basic_string_view</span><span class="o">&lt;</span><span class="n">Char</span><span class="o">&gt;</span> <span class="n">str</span><span class="p">;</span>

  <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">named_arg</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Char</span><span class="o">&gt;</span> <span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;&amp;</span><span class="n">value</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">str</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">value</span><span class="p">)};</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace internal</span>

<span class="kr">inline</span> <span class="k">namespace</span> <span class="n">literals</span> <span class="p">{</span>
<span class="cp">#if FMT_USE_UDL_TEMPLATE</span>
<span class="cp">#pragma GCC diagnostic push</span>
<span class="cp">#if FMT_CLANG_VERSION</span>
<span class="cp">#pragma GCC diagnostic ignored &quot;-Wgnu-string-literal-operator-template&quot;</span>
<span class="cp">#endif</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">Char</span><span class="p">,</span> <span class="n">Char</span><span class="p">...</span> <span class="n">CHARS</span><span class="o">&gt;</span>
<span class="n">FMT_CONSTEXPR</span> <span class="n">internal</span><span class="o">::</span><span class="n">udl_formatter</span><span class="o">&lt;</span><span class="n">Char</span><span class="p">,</span> <span class="n">CHARS</span><span class="p">...</span><span class="o">&gt;</span> <span class="k">operator</span><span class="s">&quot;&quot;</span><span class="n">_format</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{};</span>
<span class="p">}</span>
<span class="cp">#pragma GCC diagnostic pop</span>
<span class="cp">#else</span>

<span class="n">FMT_CONSTEXPR</span> <span class="n">internal</span><span class="o">::</span><span class="n">udl_formatter</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="k">operator</span><span class="s">&quot;&quot;</span> <span class="n">_format</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
                                                               <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{{</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">}};</span>
<span class="p">}</span>
<span class="n">FMT_CONSTEXPR</span> <span class="n">internal</span><span class="o">::</span><span class="n">udl_formatter</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;</span>
<span class="k">operator</span><span class="s">&quot;&quot;</span> <span class="n">_format</span><span class="p">(</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{{</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">}};</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="c1">// FMT_USE_UDL_TEMPLATE</span>

<span class="n">FMT_CONSTEXPR</span> <span class="n">internal</span><span class="o">::</span><span class="n">udl_arg</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span> <span class="k">operator</span><span class="s">&quot;&quot;</span> <span class="n">_a</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
                                                    <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{{</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">}};</span>
<span class="p">}</span>
<span class="n">FMT_CONSTEXPR</span> <span class="n">internal</span><span class="o">::</span><span class="n">udl_arg</span><span class="o">&lt;</span><span class="kt">wchar_t</span><span class="o">&gt;</span> <span class="k">operator</span><span class="s">&quot;&quot;</span> <span class="n">_a</span><span class="p">(</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
                                                       <span class="n">std</span><span class="o">::</span><span class="kt">size_t</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{{</span><span class="n">s</span><span class="p">,</span> <span class="n">n</span><span class="p">}};</span>
<span class="p">}</span>
<span class="p">}</span> <span class="c1">// namespace literals</span>
<span class="cp">#endif </span><span class="c1">// FMT_USE_USER_DEFINED_LITERALS</span>
<span class="n">FMT_END_NAMESPACE</span>

<span class="cp">#define FMT_STRING_IMPL(s, ...)                                                \</span>
<span class="cp">  [] {                                                                         \</span>
<span class="cp">    struct str : fmt::compile_string {                                         \</span>
<span class="cp">      using char_type = typename std::remove_cv&lt;std::remove_pointer&lt;           \</span>
<span class="cp">          typename std::decay&lt;decltype(s)&gt;::type&gt;::type&gt;::type;                \</span>
<span class="cp">      __VA_ARGS__ FMT_CONSTEXPR                                                \</span>
<span class="cp">      operator fmt::basic_string_view&lt;char_type&gt;() const {                     \</span>
<span class="cp">        return {s, sizeof(s) / sizeof(char_type) - 1};                         \</span>
<span class="cp">      }                                                                        \</span>
<span class="cp">    } result;                                                                  \</span>
<span class="cp">    </span><span class="cm">/* Suppress Qt Creator warning about unused operator. */</span><span class="cp">                   \</span>
<span class="cp">    (void)static_cast&lt;fmt::basic_string_view&lt;typename str::char_type&gt;&gt;(        \</span>
<span class="cp">        result);                                                               \</span>
<span class="cp">    return result;                                                             \</span>
<span class="cp">  }()</span>

<span class="cp">#define FMT_STRING(s) FMT_STRING_IMPL(s, )</span>

<span class="cp">#if defined(FMT_STRING_ALIAS) &amp;&amp; FMT_STRING_ALIAS</span>
<span class="cp">#define fmt(s) FMT_STRING_IMPL(s, [[deprecated]])</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef FMT_HEADER_ONLY</span>
<span class="cp">#define FMT_FUNC inline</span>
<span class="cp">#include</span> <span class="cpf">&quot;format-inl.h&quot;</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define FMT_FUNC</span>
<span class="cp">#endif</span>

<span class="cp">#endif </span><span class="c1">// FMT_FORMAT_H_</span>
</pre></div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, seq-lang

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>